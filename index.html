<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0d0d12">
  <title>IronLog</title>
  <script type="importmap">
  {
    "imports": {
      "preact": "https://esm.sh/preact@10.23.1",
      "preact/hooks": "https://esm.sh/preact@10.23.1/hooks",
      "htm/preact": "https://esm.sh/htm@3.1.1/preact?external=preact"
    }
  }
  </script>
  <style>
    /* ═══════════════════════════════════════════════════════════════
       RESET & CUSTOM PROPERTIES
       ═══════════════════════════════════════════════════════════════ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg-primary: #000000;
      --bg-card: #1c1c1e;
      --bg-input: #2c2c2e;
      --bg-hover: #3a3a3c;
      --bg-elevated: #1c1c1e;
      --text-primary: #f5f5f7;
      --text-secondary: #98989f;
      --text-muted: #636366;
      --accent-green: #30d158;
      --accent-red: #ff453a;
      --accent-amber: #ffd60a;
      --accent-blue: #0a84ff;
      --accent-purple: #bf5af2;
      --border: rgba(255,255,255,0.08);
      --border-strong: rgba(255,255,255,0.12);
      --radius: 14px;
      --radius-sm: 10px;
      --font: -apple-system, 'SF Pro Display', 'SF Pro Text', system-ui, sans-serif;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

    html, body {
      font-family: var(--font);
      background: var(--bg-primary);
      color: var(--text-primary);
      height: 100%;
      overflow: hidden;
      -webkit-tap-highlight-color: transparent;
      -webkit-text-size-adjust: 100%;
    }

    #app {
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    /* ═══════════════════════════════════════════════════════════════
       LAYOUT
       ═══════════════════════════════════════════════════════════════ */
    .screen {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 16px 16px calc(72px + var(--safe-bottom));
      -webkit-overflow-scrolling: touch;
    }

    .screen-title {
      font-size: 34px;
      font-weight: 700;
      margin-bottom: 20px;
      letter-spacing: -0.5px;
    }

    /* ═══════════════════════════════════════════════════════════════
       BOTTOM NAV
       ═══════════════════════════════════════════════════════════════ */
    .nav {
      display: flex;
      background: rgba(28,28,30,0.85);
      -webkit-backdrop-filter: saturate(180%) blur(20px);
      backdrop-filter: saturate(180%) blur(20px);
      border-top: 1px solid var(--border);
      padding-bottom: var(--safe-bottom);
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 100;
    }

    .nav-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 8px 0 6px;
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 10px;
      font-weight: 500;
      font-family: var(--font);
      cursor: pointer;
      transition: color 0.2s;
      -webkit-tap-highlight-color: transparent;
      letter-spacing: 0.01em;
    }

    .nav-item.active { color: var(--accent-blue); }

    .coach-msg {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      background: var(--accent-blue);
      color: #fff;
      padding: 12px 16px;
      font-size: 14px;
      font-weight: 600;
      text-align: center;
      animation: slideDown 0.3s ease;
    }
    @keyframes slideDown {
      from { transform: translateY(-100%); }
      to { transform: translateY(0); }
    }
    .nav-item svg { width: 22px; height: 22px; margin-bottom: 2px; }

    /* ═══════════════════════════════════════════════════════════════
       CARDS
       ═══════════════════════════════════════════════════════════════ */
    .card {
      background: var(--bg-card);
      border: none;
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 12px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
    }

    .card-subtitle {
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: 2px;
    }

    /* ═══════════════════════════════════════════════════════════════
       INPUTS
       ═══════════════════════════════════════════════════════════════ */
    .input-group {
      margin-bottom: 16px;
    }

    .input-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
      display: block;
    }

    .input-field {
      width: 100%;
      padding: 12px 16px;
      background: var(--bg-input);
      border: none;
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-size: 17px;
      font-family: var(--font);
      outline: none;
      transition: box-shadow 0.2s;
      -webkit-appearance: none;
    }

    .input-field:focus {
      box-shadow: 0 0 0 3px rgba(10,132,255,0.3);
    }

    /* ═══════════════════════════════════════════════════════════════
       BUTTONS
       ═══════════════════════════════════════════════════════════════ */
    .btn {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px 24px;
      border: none;
      border-radius: var(--radius);
      font-size: 17px;
      font-weight: 600;
      font-family: var(--font);
      cursor: pointer;
      transition: opacity 0.2s, transform 0.1s;
      -webkit-tap-highlight-color: transparent;
      width: 100%;
      letter-spacing: -0.2px;
    }

    .btn:active { transform: scale(0.97); opacity: 0.85; }
    .btn-primary { background: var(--accent-blue); color: white; }
    .btn-success { background: var(--accent-green); color: #000; font-weight: 700; }
    .btn-danger { background: var(--accent-red); color: white; }
    .btn-ghost {
      background: rgba(255,255,255,0.06);
      color: var(--accent-blue);
      border: none;
    }

    .btn-sm {
      padding: 8px 16px;
      font-size: 15px;
      width: auto;
      border-radius: var(--radius-sm);
    }

    /* ═══════════════════════════════════════════════════════════════
       WEIGHT INPUT STEPPER
       ═══════════════════════════════════════════════════════════════ */
    .stepper {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 2px;
      width: 100%;
    }

    .stepper-btn {
      min-width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255,255,255,0.08);
      border: none;
      border-radius: var(--radius-sm);
      color: var(--accent-blue);
      font-size: 15px;
      font-weight: 600;
      font-family: var(--font);
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      transition: background 0.15s, transform 0.1s;
      flex: 1;
      max-width: 56px;
    }

    .stepper-btn:active { background: rgba(255,255,255,0.15); transform: scale(0.93); }

    .stepper-value {
      min-width: 56px;
      text-align: center;
      font-size: 20px;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
      padding: 0 2px;
    }

    .stepper-unit {
      font-size: 12px;
      color: var(--text-secondary);
      font-weight: 400;
    }

    /* ═══════════════════════════════════════════════════════════════
       SET ROW
       ═══════════════════════════════════════════════════════════════ */
    .set-row {
      padding: 14px 0;
      border-bottom: 1px solid rgba(255,255,255,0.04);
    }

    .set-row:last-child { border-bottom: none; }

    .equipment-toggle {
      display: flex;
      gap: 6px;
      margin-bottom: 12px;
    }

    .add-exercise-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
    }
    .add-exercise-row:last-child { border-bottom: none; }
    .add-exercise-row:active { opacity: 0.6; }

    .set-row-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .set-num {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .set-weight-row {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 8px;
    }

    .set-bottom-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .set-notes {
      width: 100%;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      padding: 6px 10px;
      font-size: 13px;
      margin-top: 6px;
      outline: none;
      font-family: inherit;
    }
    .set-notes::placeholder { color: var(--text-muted); }
    .set-notes:focus { border-color: var(--accent-blue); }

    .set-check {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid rgba(255,255,255,0.12);
      background: transparent;
      color: var(--text-muted);
      font-size: 20px;
      cursor: pointer;
      transition: all 0.25s ease;
      -webkit-tap-highlight-color: transparent;
      flex-shrink: 0;
    }

    .set-check.done {
      background: var(--accent-green);
      border-color: var(--accent-green);
      color: #000;
      transform: scale(1.05);
    }

    .set-check.failed {
      background: var(--accent-red);
      border-color: var(--accent-red);
      color: white;
    }

    /* ═══════════════════════════════════════════════════════════════
       PROGRAM SELECTOR
       ═══════════════════════════════════════════════════════════════ */
    .program-option {
      padding: 14px 16px;
      background: var(--bg-card);
      border: 2px solid transparent;
      border-radius: var(--radius);
      margin-bottom: 8px;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
      -webkit-tap-highlight-color: transparent;
    }

    .program-option.selected {
      border-color: var(--accent-blue);
      background: rgba(10,132,255,0.08);
    }

    .program-option .name {
      font-weight: 600;
      font-size: 15px;
      margin-bottom: 4px;
    }

    .program-option .exercises {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.4;
    }

    /* ═══════════════════════════════════════════════════════════════
       EXERCISE CARD IN WORKOUT
       ═══════════════════════════════════════════════════════════════ */
    .exercise-card {
      background: var(--bg-card);
      border: none;
      border-radius: var(--radius);
      margin-bottom: 10px;
      overflow: hidden;
    }

    .exercise-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 16px;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }

    .exercise-name {
      font-size: 16px;
      font-weight: 700;
    }

    .exercise-target {
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: 2px;
    }

    .exercise-badge {
      font-size: 12px;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 20px;
      flex-shrink: 0;
    }

    .exercise-badge.pending {
      background: rgba(255,255,255,0.06);
      color: var(--text-secondary);
    }

    .exercise-badge.partial {
      background: rgba(255,214,10,0.12);
      color: var(--accent-amber);
    }

    .exercise-badge.complete {
      background: rgba(48,209,88,0.12);
      color: var(--accent-green);
    }

    .exercise-body {
      padding: 0 16px 14px;
    }

    .exercise-rec {
      font-size: 13px;
      color: var(--accent-blue);
      margin-bottom: 10px;
      padding: 8px 12px;
      background: rgba(10,132,255,0.08);
      border-radius: var(--radius-sm);
    }

    /* ═══════════════════════════════════════════════════════════════
       MUSCLE MAP
       ═══════════════════════════════════════════════════════════════ */
    .muscle-map-container {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 16px;
    }

    .muscle-view {
      text-align: center;
    }

    .muscle-view .view-label {
      font-size: 10px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 4px;
    }

    .muscle-map-container svg {
      width: 100%;
      max-width: 160px;
      height: auto;
    }

    .muscle-map-container.mini svg {
      max-width: 110px;
    }

    .muscle-region {
      fill: #1c1c1e;
      stroke: rgba(255,255,255,0.06);
      stroke-width: 1;
      transition: fill 0.3s ease;
    }

    .muscle-region.planned {
      fill: var(--accent-blue);
      fill-opacity: 0.4;
    }

    .muscle-region.completed {
      fill: var(--accent-green);
      fill-opacity: 0.7;
    }

    .muscle-region.partial {
      fill: var(--accent-amber);
      fill-opacity: 0.5;
    }

    .body-outline {
      fill: none;
      stroke: rgba(255,255,255,0.1);
      stroke-width: 1.5;
    }

    /* ═══════════════════════════════════════════════════════════════
       LEGEND
       ═══════════════════════════════════════════════════════════════ */
    .legend {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-bottom: 16px;
      font-size: 11px;
      color: var(--text-secondary);
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    /* ═══════════════════════════════════════════════════════════════
       HISTORY
       ═══════════════════════════════════════════════════════════════ */
    .history-card {
      background: var(--bg-card);
      border: none;
      border-radius: var(--radius);
      padding: 14px 16px;
      margin-bottom: 8px;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      transition: background 0.15s;
    }

    .history-card:active {
      background: var(--bg-hover);
    }

    .history-date {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .history-meta {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .history-exercises {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .history-ex-tag {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 4px;
      font-weight: 500;
    }

    .history-ex-tag.success {
      background: rgba(48,209,88,0.12);
      color: var(--accent-green);
    }

    .history-ex-tag.fail {
      background: rgba(255,69,58,0.12);
      color: var(--accent-red);
    }

    /* ═══════════════════════════════════════════════════════════════
       PROGRESS CHART
       ═══════════════════════════════════════════════════════════════ */
    .chart-container {
      margin-top: 12px;
    }

    .chart-container svg {
      width: 100%;
      height: 150px;
    }

    .chart-bar {
      fill: var(--accent-blue);
      rx: 4;
    }

    .chart-bar.fail {
      fill: var(--accent-red);
      fill-opacity: 0.5;
    }

    .chart-label {
      fill: var(--text-muted);
      font-size: 9px;
      text-anchor: middle;
    }

    .chart-value {
      fill: var(--text-secondary);
      font-size: 10px;
      text-anchor: middle;
      font-weight: 600;
    }

    /* Stats grid for exercise detail */
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 16px;
    }

    .stat-card {
      background: var(--bg-card);
      border-radius: var(--radius);
      padding: 12px;
    }

    .stat-label {
      font-size: 11px;
      color: var(--text-secondary);
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-value {
      font-size: 20px;
      font-weight: 700;
    }

    .stat-sub {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .trend-up { color: var(--accent-green); }
    .trend-down { color: var(--accent-red); }
    .trend-flat { color: var(--text-secondary); }

    /* Sparkline in exercise progress cards */
    .sparkline-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .sparkline-row svg {
      flex-shrink: 0;
    }

    /* Range filter buttons */
    .range-filters {
      display: flex;
      gap: 6px;
      margin-bottom: 12px;
    }

    .range-btn {
      padding: 5px 10px;
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,0.1);
      background: none;
      color: var(--text-secondary);
      font-size: 12px;
      cursor: pointer;
    }

    .range-btn.active {
      background: var(--accent-blue);
      color: #fff;
      border-color: var(--accent-blue);
    }

    /* ═══════════════════════════════════════════════════════════════
       SESSION HEADER
       ═══════════════════════════════════════════════════════════════ */
    .session-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding: 12px 16px;
      background: var(--bg-card);
      border-radius: var(--radius);
      border: none;
    }

    .session-header .info {
      font-size: 14px;
      font-weight: 600;
    }

    .session-header .meta {
      font-size: 12px;
      color: var(--text-secondary);
    }

    /* ═══════════════════════════════════════════════════════════════
       FEELING CHECK
       ═══════════════════════════════════════════════════════════════ */
    .feeling-row {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    .feeling-btn {
      flex: 1;
      padding: 10px;
      border: 2px solid transparent;
      border-radius: var(--radius-sm);
      background: rgba(255,255,255,0.06);
      color: var(--text-secondary);
      font-size: 15px;
      font-weight: 500;
      font-family: var(--font);
      cursor: pointer;
      text-align: center;
      transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
    }

    .feeling-btn.selected {
      border-color: var(--accent-blue);
      color: var(--text-primary);
      background: rgba(10,132,255,0.12);
    }

    /* ═══════════════════════════════════════════════════════════════
       EMPTY STATE
       ═══════════════════════════════════════════════════════════════ */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }

    .empty-state .icon {
      font-size: 40px;
      margin-bottom: 12px;
    }

    /* ═══════════════════════════════════════════════════════════════
       MINI STEPPER (for reps)
       ═══════════════════════════════════════════════════════════════ */
    .mini-stepper {
      display: flex;
      align-items: center;
      gap: 2px;
    }

    .mini-stepper {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .mini-stepper .stepper-btn {
      min-width: 44px;
      height: 44px;
      font-size: 18px;
      flex: none;
    }

    .mini-stepper .stepper-value {
      min-width: 36px;
      font-size: 20px;
    }

    .reps-label {
      font-size: 12px;
      color: var(--text-secondary);
      margin-right: 6px;
      font-weight: 600;
    }

    /* ═══════════════════════════════════════════════════════════════
       DETAIL VIEW
       ═══════════════════════════════════════════════════════════════ */
    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid rgba(255,255,255,0.04);
      font-size: 15px;
    }

    .detail-row:last-child { border-bottom: none; }

    .back-btn {
      background: none;
      border: none;
      color: var(--accent-blue);
      font-size: 17px;
      font-weight: 400;
      font-family: var(--font);
      cursor: pointer;
      padding: 4px 0;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    /* ═══════════════════════════════════════════════════════════════
       TIMER
       ═══════════════════════════════════════════════════════════════ */
    .timer {
      font-variant-numeric: tabular-nums;
      color: var(--text-secondary);
      font-size: 13px;
    }

    /* ═══════════════════════════════════════════════════════════════
       ANIMATIONS
       ═══════════════════════════════════════════════════════════════ */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .fade-in { animation: fadeIn 0.25s ease-out; }

    /* ═══════════════════════════════════════════════════════════════
       SCROLLBAR
       ═══════════════════════════════════════════════════════════════ */
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    /* ═══════════════════════════════════════════════════════════════
       STEPPER INPUT (tap-to-type)
       ═══════════════════════════════════════════════════════════════ */
    .stepper-input {
      width: 80px;
      text-align: center;
      font-size: 20px;
      font-weight: 700;
      font-family: var(--font);
      background: var(--bg-input);
      border: none;
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      padding: 6px;
      outline: none;
      box-shadow: 0 0 0 3px rgba(10,132,255,0.4);
      -webkit-appearance: none;
      -moz-appearance: textfield;
    }
    .stepper-input::-webkit-inner-spin-button,
    .stepper-input::-webkit-outer-spin-button { -webkit-appearance: none; }

    /* ═══════════════════════════════════════════════════════════════
       PLATE CALCULATOR
       ═══════════════════════════════════════════════════════════════ */
    .plate-calc {
      text-align: center;
      font-size: 11px;
      color: var(--accent-blue);
      margin-top: 4px;
      font-weight: 500;
    }

    /* ═══════════════════════════════════════════════════════════════
       REST TIMER
       ═══════════════════════════════════════════════════════════════ */
    .rest-timer-overlay {
      position: fixed;
      bottom: 72px;
      left: 0;
      right: 0;
      padding: 0 16px calc(var(--safe-bottom) + 8px);
      z-index: 99;
      pointer-events: none;
    }

    .rest-timer-card {
      background: rgba(28,28,30,0.92);
      -webkit-backdrop-filter: saturate(180%) blur(20px);
      backdrop-filter: saturate(180%) blur(20px);
      border: none;
      border-radius: var(--radius);
      padding: 16px 18px;
      pointer-events: all;
      animation: fadeIn 0.25s ease-out;
    }

    .rest-timer-card.done {
      background: rgba(48,209,88,0.12);
    }

    .rest-timer-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .rest-timer-display {
      font-size: 32px;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
      margin-bottom: 8px;
    }

    .rest-timer-bar {
      height: 4px;
      background: var(--bg-input);
      border-radius: 2px;
      overflow: hidden;
      margin-bottom: 10px;
    }

    .rest-timer-fill {
      height: 100%;
      background: var(--accent-blue);
      border-radius: 2px;
      transition: width 1s linear;
    }

    .rest-timer-card.done .rest-timer-fill {
      background: var(--accent-green);
    }

    .rest-timer-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .rest-timer-actions .btn {
      flex: 1;
      min-width: auto;
      padding: 6px 10px;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div id="app"></div>
  <script type="module">
// ═══════════════════════════════════════════════════════════════
// SECTION 1: IMPORTS
// ═══════════════════════════════════════════════════════════════
import { render } from 'preact';
import { useState, useEffect, useReducer, useCallback, useRef, useMemo } from 'preact/hooks';
import { html } from 'htm/preact';

// ═══════════════════════════════════════════════════════════════
// SECTION 2: CONSTANTS & DATA
// ═══════════════════════════════════════════════════════════════

const MUSCLE_GROUPS = {
  traps:       { label: 'Traps',       view: 'both'  },
  chest:       { label: 'Chest',       view: 'front' },
  front_delts: { label: 'Front Delts', view: 'front' },
  side_delts:  { label: 'Side Delts',  view: 'both'  },
  biceps:      { label: 'Biceps',      view: 'front' },
  forearms:    { label: 'Forearms',    view: 'both'  },
  abs:         { label: 'Abs',         view: 'front' },
  obliques:    { label: 'Obliques',    view: 'front' },
  quads:       { label: 'Quads',       view: 'front' },
  rear_delts:  { label: 'Rear Delts',  view: 'back'  },
  triceps:     { label: 'Triceps',     view: 'back'  },
  upper_back:  { label: 'Upper Back',  view: 'back'  },
  lats:        { label: 'Lats',        view: 'back'  },
  lower_back:  { label: 'Lower Back',  view: 'back'  },
  glutes:      { label: 'Glutes',      view: 'back'  },
  hamstrings:  { label: 'Hamstrings',  view: 'back'  },
  calves:      { label: 'Calves',      view: 'back'  },
  adductors:   { label: 'Adductors',  view: 'both'  },
};

const EXERCISES = {
  squat: {
    id: 'squat', name: 'Squat', category: 'compound',
    primaryMuscles: ['quads', 'glutes'],
    secondaryMuscles: ['hamstrings', 'lower_back', 'abs', 'adductors'],
    defaultSets: 3, defaultReps: 5, incrementLbs: 5,
  },
  bench_press: {
    id: 'bench_press', name: 'Bench Press', category: 'compound',
    primaryMuscles: ['chest', 'front_delts'],
    secondaryMuscles: ['triceps'],
    defaultSets: 3, defaultReps: 5, incrementLbs: 2.5,
  },
  overhead_press: {
    id: 'overhead_press', name: 'Overhead Press', category: 'compound',
    primaryMuscles: ['front_delts', 'side_delts'],
    secondaryMuscles: ['triceps', 'upper_back', 'traps'],
    defaultSets: 3, defaultReps: 5, incrementLbs: 2.5,
  },
  deadlift: {
    id: 'deadlift', name: 'Deadlift', category: 'compound',
    primaryMuscles: ['hamstrings', 'glutes', 'lower_back'],
    secondaryMuscles: ['quads', 'upper_back', 'lats', 'forearms', 'traps', 'adductors'],
    defaultSets: 1, defaultReps: 5, incrementLbs: 5,
  },
  barbell_row: {
    id: 'barbell_row', name: 'Barbell Row', category: 'compound',
    primaryMuscles: ['upper_back', 'lats'],
    secondaryMuscles: ['rear_delts', 'biceps', 'forearms', 'lower_back', 'traps'],
    defaultSets: 3, defaultReps: 5, incrementLbs: 5,
  },
  face_pull: {
    id: 'face_pull', name: 'Face Pull', category: 'accessory',
    primaryMuscles: ['rear_delts', 'upper_back'],
    secondaryMuscles: ['side_delts', 'traps'],
    defaultSets: 3, defaultReps: 15, incrementLbs: 5,
    equipmentType: 'cable',
  },
  lat_pulldown: {
    id: 'lat_pulldown', name: 'Lat Pulldown', category: 'accessory',
    primaryMuscles: ['lats', 'upper_back'],
    secondaryMuscles: ['biceps', 'rear_delts', 'forearms'],
    defaultSets: 3, defaultReps: 10, incrementLbs: 5,
    equipmentType: 'cable',
  },
  chin_up: {
    id: 'chin_up', name: 'Chin-Up', category: 'compound',
    primaryMuscles: ['lats', 'biceps'],
    secondaryMuscles: ['upper_back', 'forearms'],
    defaultSets: 3, defaultReps: 8, incrementLbs: 5,
    equipmentType: 'bodyweight',
  },
  dip: {
    id: 'dip', name: 'Dip', category: 'compound',
    primaryMuscles: ['chest', 'triceps'],
    secondaryMuscles: ['front_delts'],
    defaultSets: 3, defaultReps: 8, incrementLbs: 5,
    equipmentType: 'bodyweight',
  },
  romanian_deadlift: {
    id: 'romanian_deadlift', name: 'Romanian Deadlift', category: 'compound',
    primaryMuscles: ['hamstrings', 'glutes'],
    secondaryMuscles: ['lower_back'],
    defaultSets: 3, defaultReps: 8, incrementLbs: 5,
  },
  leg_press: {
    id: 'leg_press', name: 'Leg Press', category: 'compound',
    primaryMuscles: ['quads', 'glutes'],
    secondaryMuscles: ['hamstrings', 'adductors'],
    defaultSets: 3, defaultReps: 10, incrementLbs: 10,
    equipmentType: 'machine',
  },
  calf_raise: {
    id: 'calf_raise', name: 'Calf Raise', category: 'accessory',
    primaryMuscles: ['calves'],
    secondaryMuscles: [],
    defaultSets: 3, defaultReps: 15, incrementLbs: 5,
    equipmentType: 'machine',
  },
  barbell_curl: {
    id: 'barbell_curl', name: 'Barbell Curl', category: 'accessory',
    primaryMuscles: ['biceps'],
    secondaryMuscles: ['forearms'],
    defaultSets: 3, defaultReps: 10, incrementLbs: 2.5,
  },
  tricep_pushdown: {
    id: 'tricep_pushdown', name: 'Tricep Pushdown', category: 'accessory',
    primaryMuscles: ['triceps'],
    secondaryMuscles: [],
    defaultSets: 3, defaultReps: 12, incrementLbs: 5,
    equipmentType: 'cable',
  },
};

// ── 5/3/1 "Less Boring But Big" ──────────────────────────────
// Main lifts: squat, bench_press, deadlift, overhead_press
// Supplemental BBB swap: squat↔deadlift, bench↔ohp

const MAIN_LIFTS = ['squat', 'bench_press', 'deadlift', 'overhead_press'];

const BBB_SWAP = {
  squat: 'deadlift',
  deadlift: 'squat',
  bench_press: 'overhead_press',
  overhead_press: 'bench_press',
};

// Week schemes: [percent of TM, target reps]
const WEEK_SCHEMES = {
  1: { name: '5s Week',   main: [[0.65, 5], [0.75, 5], [0.85, 5]],   bbb: 0.50 },
  2: { name: '3s Week',   main: [[0.70, 3], [0.80, 3], [0.90, 3]],   bbb: 0.50 },
  3: { name: '5/3/1 Week', main: [[0.75, 5], [0.85, 3], [0.95, 1]],  bbb: 0.50 },
  4: { name: 'Deload',     main: [[0.40, 5], [0.50, 5], [0.60, 5]],  bbb: 0.40 },
};

// Accessories per day (push/pull/single-leg or core)
const DAY_ACCESSORIES = {
  squat:          [{ exerciseId: 'leg_press', sets: 3, reps: 10 }, { exerciseId: 'barbell_curl', sets: 3, reps: 10 }, { exerciseId: 'face_pull', sets: 3, reps: 15 }],
  bench_press:    [{ exerciseId: 'dip', sets: 3, reps: 8 }, { exerciseId: 'barbell_row', sets: 3, reps: 10 }, { exerciseId: 'face_pull', sets: 3, reps: 15 }],
  deadlift:       [{ exerciseId: 'romanian_deadlift', sets: 3, reps: 8 }, { exerciseId: 'chin_up', sets: 3, reps: 8 }, { exerciseId: 'calf_raise', sets: 3, reps: 15 }],
  overhead_press: [{ exerciseId: 'tricep_pushdown', sets: 3, reps: 12 }, { exerciseId: 'lat_pulldown', sets: 3, reps: 10 }, { exerciseId: 'barbell_curl', sets: 3, reps: 10 }],
};

// 5/3/1 programs — one per main lift day
const PROGRAMS = {};
MAIN_LIFTS.forEach(lift => {
  const ex = EXERCISES[lift];
  PROGRAMS[lift] = {
    id: lift,
    name: `${ex.name} Day`,
    mainLift: lift,
    bbbLift: BBB_SWAP[lift],
    accessories: DAY_ACCESSORIES[lift],
  };
});

// Plate calculator: available plates per side (lbs), bar = 45
const BAR_WEIGHT = 45;
const PLATES = [45, 25, 10, 5, 2.5, 1.25];

// Available dumbbell sizes (lbs) — 2.5lb steps below 30, 5lb steps 30+
const DUMBBELLS = [
  5, 7.5, 10, 12.5, 15, 17.5, 20, 22.5, 25, 27.5, 30,
  35, 40, 45, 50, 55, 60, 65, 70, 75, 80, 85, 90, 95, 100
];

function nearestDumbbell(target) {
  let closest = DUMBBELLS[0];
  for (const db of DUMBBELLS) {
    if (Math.abs(db - target) < Math.abs(closest - target)) closest = db;
  }
  return closest;
}

function calculatePlates(totalWeight) {
  if (totalWeight <= BAR_WEIGHT) return [];
  let remaining = (totalWeight - BAR_WEIGHT) / 2;
  const result = [];
  for (const plate of PLATES) {
    while (remaining >= plate) {
      result.push(plate);
      remaining -= plate;
    }
  }
  return result;
}

function roundTo5(weight) {
  return Math.round(weight / 5) * 5;
}

// Build the sets for a 5/3/1 workout day
function build531Exercises(mainLiftId, cycleWeek, trainingMaxes, exerciseHistory) {
  const week = WEEK_SCHEMES[cycleWeek] || WEEK_SCHEMES[1];
  const tm = trainingMaxes[mainLiftId] || 0;
  const bbbLift = BBB_SWAP[mainLiftId];
  const bbbTm = trainingMaxes[bbbLift] || 0;
  const program = PROGRAMS[mainLiftId];

  const exercises = [];

  // Main lift: 3 working sets
  exercises.push({
    exerciseId: mainLiftId,
    category: 'main',
    label: '5/3/1',
    sets: week.main.map(([pct, reps]) => ({
      weight: roundTo5(tm * pct),
      reps,
      targetReps: reps,
      completed: false,
      pct,
    })),
  });

  // BBB supplemental: 5x10 at BBB percentage
  const bbbWeight = roundTo5(bbbTm * week.bbb);
  exercises.push({
    exerciseId: bbbLift,
    category: 'supplemental',
    label: 'BBB 5×10',
    sets: Array.from({ length: 5 }, () => ({
      weight: bbbWeight,
      reps: 10,
      targetReps: 10,
      completed: false,
      pct: week.bbb,
    })),
  });

  // Accessories — pre-fill weight from exercise history
  program.accessories.forEach(acc => {
    const next = exerciseHistory ? calculateNextWeight(acc.exerciseId, exerciseHistory) : null;
    const lastWeight = next ? next.weight : 0;
    exercises.push({
      exerciseId: acc.exerciseId,
      category: 'accessory',
      label: 'Accessory',
      sets: Array.from({ length: acc.sets }, () => ({
        weight: lastWeight,
        reps: acc.reps,
        targetReps: acc.reps,
        completed: false,
      })),
    });
  });

  return exercises;
}

const MAX_CONSECUTIVE_FAILURES = 3;
const DELOAD_PERCENT = 0.10;

// ═══════════════════════════════════════════════════════════════
// SECTION 3: STORAGE
// ═══════════════════════════════════════════════════════════════

const STORAGE_KEY = 'ironlog_v2';
const CURRENT_VERSION = 2;

function loadState() {
  try {
    // Try v2 first, fall back to v1
    let raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) {
      raw = localStorage.getItem('ironlog_v1');
      if (!raw) return null;
    }
    const parsed = JSON.parse(raw);
    // Migrate v1 → v2: add new fields
    if (!parsed.trainingMaxes) parsed.trainingMaxes = {};
    if (!parsed.cycleWeek) parsed.cycleWeek = 1;
    if (!parsed.cycleNumber) parsed.cycleNumber = 1;
    return parsed;
  } catch {
    return null;
  }
}

function saveState(state) {
  const { screen, expandedExercise, detailView, restTimer, ...persistable } = state;
  localStorage.setItem(STORAGE_KEY, JSON.stringify({
    ...persistable,
    version: CURRENT_VERSION,
  }));
}

// ═══════════════════════════════════════════════════════════════
// SECTION 4: BUSINESS LOGIC
// ═══════════════════════════════════════════════════════════════

function roundToNearest(weight, increment) {
  return Math.round(weight / increment) * increment;
}

function calculateNextWeight(exerciseId, exerciseHistory) {
  const history = exerciseHistory[exerciseId];
  if (!history || history.history.length === 0) return null;

  const lastEntry = history.history[0];
  const lastWeight = lastEntry.weight;
  const increment = EXERCISES[exerciseId]?.incrementLbs || 5;

  if (history.consecutiveFailures >= MAX_CONSECUTIVE_FAILURES) {
    const deloadWeight = roundToNearest(lastWeight * (1 - DELOAD_PERCENT), 2.5);
    return { weight: deloadWeight, reason: 'deload', message: `Deload: 3 fails at ${lastWeight}. Try ${deloadWeight}.` };
  }

  if (!lastEntry.allCompleted) {
    return { weight: lastWeight, reason: 'retry', message: `Retry ${lastWeight} (missed reps last time)` };
  }

  const nextWeight = lastWeight + increment;
  return { weight: nextWeight, reason: 'progress', message: `+${increment} lbs from last session` };
}

// getPlannedMuscles is defined below with the StartScreen

function getCompletedMuscles(sessionExercises) {
  const muscles = new Set();
  if (!sessionExercises) return [];
  sessionExercises.forEach(se => {
    const allDone = se.sets.every(s => s.completed);
    if (allDone) {
      const ex = EXERCISES[se.exerciseId];
      if (ex) {
        ex.primaryMuscles.forEach(m => muscles.add(m));
        ex.secondaryMuscles.forEach(m => muscles.add(m));
      }
    }
  });
  return [...muscles];
}

function getPartialMuscles(sessionExercises) {
  const muscles = new Set();
  const completed = new Set(getCompletedMuscles(sessionExercises));
  if (!sessionExercises) return [];
  sessionExercises.forEach(se => {
    const anyDone = se.sets.some(s => s.completed);
    const allDone = se.sets.every(s => s.completed);
    if (anyDone && !allDone) {
      const ex = EXERCISES[se.exerciseId];
      if (ex) {
        ex.primaryMuscles.forEach(m => { if (!completed.has(m)) muscles.add(m); });
        ex.secondaryMuscles.forEach(m => { if (!completed.has(m)) muscles.add(m); });
      }
    }
  });
  return [...muscles];
}

function updateExerciseHistory(exerciseHistory, exerciseId, weight, allCompleted, date) {
  const existing = exerciseHistory[exerciseId] || {
    lastWeight: 0, lastCompleted: false, consecutiveFailures: 0, history: []
  };

  let consecutiveFailures = existing.consecutiveFailures;
  if (allCompleted) {
    consecutiveFailures = 0;
  } else if (weight === existing.lastWeight) {
    consecutiveFailures += 1;
  } else {
    consecutiveFailures = 1;
  }

  return {
    lastWeight: weight,
    lastCompleted: allCompleted,
    consecutiveFailures,
    history: [
      { date, weight, allCompleted },
      ...existing.history.slice(0, 49)
    ]
  };
}

function formatTime(timeStr) {
  if (!timeStr) return '';
  const [h, m] = timeStr.split(':').map(Number);
  const ampm = h >= 12 ? 'PM' : 'AM';
  const hour = h % 12 || 12;
  return `${hour}:${m.toString().padStart(2, '0')} ${ampm}`;
}

function nowTimeStr() {
  const d = new Date();
  return `${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
}

function todayStr() {
  return new Date().toISOString().slice(0, 10);
}

function formatDate(dateStr) {
  const d = new Date(dateStr + 'T12:00:00');
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

// ═══════════════════════════════════════════════════════════════
// SECTION 5: SVG MUSCLE MAP
// ═══════════════════════════════════════════════════════════════

// Anatomical SVG paths from react-native-body-highlighter (MIT license)

const FRONT_MUSCLE_PATHS = {
  traps: [
    "M285.01 307.01a.89.89 0 01-.11-1.64q19.44-9.61 35.65-24.8 1.68-1.57 3.31-.31.4.32.45.82 1.25 12.61-1.57 25.41c-.74 3.32-2.55 4.23-5.9 4.48q-16.02 1.24-31.83-3.96z",
    "M414 311.19c-5.24-.12-7.81-.64-8.9-6.27q-2.33-12.09-1.17-23.94.06-.61.61-.89 1.66-.85 3.65.99 16.12 14.87 33.97 23.63 3.65 1.79-.27 2.89-13.88 3.91-27.89 3.59z",
  ],
  chest: [
    "M272.91 422.84c-18.95-17.19-22-57-12.64-78.79 5.57-12.99 26.54-24.37 39.97-25.87q20.36-2.26 37.02.75c9.74 1.76 16.13 15.64 18.41 25.04 3.99 16.48 3.23 31.38 1.67 48.06q-1.35 14.35-2.05 16.89c-6.52 23.5-38.08 29.23-58.28 24.53-9.12-2.12-17.24-4.38-24.1-10.61z",
    "M416.04 435c-15.12.11-34.46-6.78-41.37-21.48q-1.88-3.99-2.84-12.18c-2.89-24.41-5.9-53.65 8.44-74.79 4.26-6.26 10.49-7.93 18.36-8.56q11.66-.92 23.32-.35c10.58.53 18.02 2.74 26.62 7.87 12.81 7.65 19.73 14.52 22.67 29.75 4.94 25.57.24 64.14-28.21 74.97q-12.26 4.67-26.99 4.77z",
  ],
  front_delts: [
    "M274.06 311.69q3.94 2.77 4.33 8.14.04.48-.38.73c-9.98 5.88-24.35 7.45-28.82 19.75-2.31 6.36-.97 17.35-1.43 23.68q-.55 7.51-5.73 14.07-10.37 13.11-13.81 16.67c-3.41 3.53-6.81 1.76-10.69-.47-15.42-8.87-24.95-25.45-22.52-43.22 2.05-14.92 12.71-25.79 24.06-35.02 16.99-13.82 35.58-17.99 54.99-4.33z",
    "M450.39 320.75q-.95-.52-.7-1.58c1.57-6.61 5.8-9.1 12.14-11.9 24.99-11.03 43.76 3.33 60.17 20.74 20.73 21.99 11.81 56.44-14.82 68.19-4.41 1.94-6.79-1.03-9.81-4.51-5.81-6.7-13.46-14.12-15.99-22.8-3.93-13.43 4.32-27.54-9.64-37.62q-8.22-5.93-17.99-9.08-1.84-.59-3.36-1.44z",
  ],
  side_delts: [
    "M274.06 311.69q3.94 2.77 4.33 8.14.04.48-.38.73c-9.98 5.88-24.35 7.45-28.82 19.75-2.31 6.36-.97 17.35-1.43 23.68q-.55 7.51-5.73 14.07-10.37 13.11-13.81 16.67c-3.41 3.53-6.81 1.76-10.69-.47-15.42-8.87-24.95-25.45-22.52-43.22 2.05-14.92 12.71-25.79 24.06-35.02 16.99-13.82 35.58-17.99 54.99-4.33z",
    "M450.39 320.75q-.95-.52-.7-1.58c1.57-6.61 5.8-9.1 12.14-11.9 24.99-11.03 43.76 3.33 60.17 20.74 20.73 21.99 11.81 56.44-14.82 68.19-4.41 1.94-6.79-1.03-9.81-4.51-5.81-6.7-13.46-14.12-15.99-22.8-3.93-13.43 4.32-27.54-9.64-37.62q-8.22-5.93-17.99-9.08-1.84-.59-3.36-1.44z",
  ],
  biceps: [
    "M189.52 492.51c-2.43.62-7.38.57-7.51-3.08-.56-16.01-.42-35.49 5.11-50.26 3.19-8.54 13.89-30.22 23.27-32.72 10.08-2.68 12.68 16.59 12.6 22.8-.22 15.98-7.51 34.79-15.05 48.71-4.29 7.94-9.95 12.38-18.42 14.55z",
    "M526.69 486.31c-9.9-8.61-17.75-33.21-20.65-47.73-1.41-7.06-1.34-29.61 8.58-32.16 10.33-2.66 23.81 25.34 26.6 32.91q2.6 7.04 3.6 16.13 1.62 14.66 1.66 32.28c.03 11.04-16.45 1.48-19.79-1.43z",
  ],
  triceps: [
    "M206.2 514.2c-5.41-.67-6.55-7.29-4.69-11.42 11.08-24.55 22.84-50.62 30.54-75.51 1.37-4.41 3.08-8.59 3.95-12.45q2.94-13.12 5.79-26.26.42-1.98 1.82-3.39a.52.52 0 01.81.1q1.04 1.69 1.94 4.56 4.63 14.65 5.15 24.92c.57 11.36-5.11 24.55-8.65 35.5q-7.69 23.78-20.25 45.39c-2.45 4.23-11.51 19.18-16.41 18.56z",
    "M517.69 512.06c-20.07-22.12-28.95-51.73-38.01-79.03-3.27-9.87-3.58-19.18-1.34-29.38 1.29-5.88 2.49-13.03 5.61-18.52q.32-.57.72-.06 1.35 1.67 1.79 3.69c2.67 12.33 5.14 24.49 9.07 36.52 8.25 25.28 18.58 49.8 31.1 77.2q1.42 3.1 1.05 5.33c-.81 4.89-5.46 9.25-9.99 4.25z",
  ],
  forearms: [
    "M127.23 683.05c-4.07-2.12 1.27-27.07 2.25-31.57 4.98-23.03 9.17-46.17 13.91-69.25q1.53-7.47 2.13-15.13c.93-12.09.81-22.15 6.23-31.59 7.1-12.33 13.54-29.16 26.1-36.73a1.98 1.97 62.7 012.84.91c1.92 4.48 1.93 8.28 2.06 14.15.44 19.77-1.3 41.04-8.72 59.67-11 27.62-22.22 55.21-32.62 82.91-4.04 10.76-7.56 20.66-12.82 26.39q-.59.65-1.36.24z",
    "M201.5 527.4a.84.84 0 01.67.65c3.98 17.15-2.93 39.36-10.95 54.41-4.6 8.63-13.06 20.43-18.21 31.33q-13.21 27.92-24.58 56.64-2.51 6.35-6.61 11.02a1.43 1.43 0 01-2.5-.81q-.36-3.78.84-7.17 10.31-29.18 21.57-57.99c6.32-16.18 14.55-31.65 20.66-47.87 3.69-9.82 5.36-22.36 7.32-30.62 1.49-6.27 4.19-11.06 11.79-9.59z",
    "M207.33 540.4a.6.59-63.1 011.03-.34l5.38 6.02q.4.45.33 1.06-.52 4.1-1.29 5.84-6.91 15.65-13.69 31.35c-5.41 12.53-16.33 28.4-23.51 44.89-8.3 19.08-16.03 39.32-26.75 57.16a.36.36 0 01-.62 0l-.19-.32q-.17-.28-.06-.59 10.08-29.91 23.05-58.65 2.9-6.42 5.47-11.21c4.62-8.59 10.86-16.17 14.62-23.02q13.23-24.13 16.23-52.19z",
    "M600.08 683.04c-5-4.14-8.97-15.46-11.29-21.56-5.82-15.25-11.38-30.55-17.58-45.7q-9.15-22.39-18.02-44.89c-5.58-14.19-7.32-31.42-7.99-46.57-.29-6.44-.68-19.43 2.67-25.02a1.71 1.71 0 012.25-.63c6.72 3.52 11.29 9.96 14.87 16.5q6.25 11.38 12.68 22.66c1.97 3.45 2.93 7.66 3.41 12.06 1.16 10.6 1.55 21.29 3.66 31.65 3.93 19.29 7.38 38.63 11.47 57.92 1.5 7.07 9.3 39.08 5.12 43.5a.91.91 0 01-1.25.08z",
    "M586.58 681.46q-4.35-4.47-6.75-10.61-11.35-28.91-24.59-57.01c-5.72-12.13-14.32-22.86-19.97-35.1-7.1-15.36-12.9-33.32-9.27-50.31a1.44 1.43-87.1 011.23-1.12c7.47-.88 9.29 2.88 11.02 9.2 3.39 12.42 4.76 25.91 9.75 36.7 15.55 33.65 27.61 64.94 39.31 98.42 1.13 3.24 2.05 5.47 1.62 9.04a1.38 1.37 26.3 01-2.35.79z",
    "M579.58 686.43q-3.92-5.77-6.87-12.13-8.05-17.34-19.75-44.5-2.68-6.24-6.46-13.62c-5.14-10.05-13.15-22.36-17.34-31.85q-9.55-21.68-13.66-31.36-1.09-2.58-1.33-5.87-.04-.61.37-1.07l5.24-5.85a.69.69 0 011.2.4q2.74 27.05 15.49 50.75 1.7 3.17 8.26 12.86 7.02 10.39 12.18 21.88 8.71 19.41 20.19 50.1 2.22 5.92 3.13 9.98a.36.36 0 01-.65.28z",
  ],
  abs: [
    "M311.02 531.71a.23.23 0 01-.19-.21q-.39-10.47 1.9-20.76c1.26-5.69 7.66-9.9 13.1-12.9 9.09-5.01 18.93-11.15 28.56-14.92a1.24 1.21-42.6 01.94.03c3.28 1.52 4.78 3.87 4.82 7.68q.13 13.16-.15 26.31c-.08 3.85.78 8.39-.87 13.1q-.17.46-.59.72-2.65 1.65-4.29 1.82-21.06 2.22-43.23-.87z",
    "M321 577.76c-5.17-.33-8.71-.44-10-6.26q-3.2-14.44-.59-27.83.11-.53.64-.63c7.58-1.44 13.62-2.45 22.45-4.56q11.5-2.76 23.94-1.88c3.67.26 3.3 3.46 3.4 6.21q.46 12.55-.33 26.94-.25 4.41-1.81 8.08-.21.49-.73.6-1.39.28-3.22.29-16.89.14-33.75-.96z",
    "M347.73 429.25c7.46-3.61 10.5 6.27 10.99 11.52.48 5.06 3.46 30.61-2.78 32.93q-4.17 1.55-6.89 3.33-17.56 11.54-35.88 21.46a1.6 1.59-21.9 01-2.3-.98c-2.87-10.41-10.59-43.96 1.66-50.95 11.3-6.45 23.96-11.86 35.2-17.31z",
    "M350.35 712.81c-29.15-9.93-37.98-100.69-39.47-126.61a.99.99 0 01.33-.8c3.58-3.26 27.61-1.47 34.62-.93 4.41.34 15.27 1.31 15.26 7.53-.05 40.77.64 82.05-1.96 122.72a1.29 1.29 0 01-1.86 1.08c-2.3-1.14-4.12-2.04-6.92-2.99z",
    "M371.94 473.31c-5.46-2.59-2.97-24.26-2.77-29.56.25-6.8 2.41-18.63 12.64-13.8q16.26 7.67 32.34 15.72 6.18 3.1 7.13 10.05c.58 4.26 1.35 8.49 1.07 12.72q-.84 12.55-4.33 26.56-.54 2.16-1.1 3.44-.25.58-.81.31c-15.78-7.29-30.79-19.08-44.17-25.44z",
    "M382.57 533.27c-4.17-.18-9.56-.3-13.15-2.69q-.17-.11-.24-.31c-1.82-5.55-.86-11.17-.96-15.66-.18-8.4-.78-17.36.06-25.71.29-2.85 1.88-4.42 4.15-5.79q.42-.26.91-.19 1.71.25 3.21 1.03 12.48 6.44 24.75 13.26c4.96 2.75 12.21 7.02 13.72 12.41q2.93 10.56 2.39 21.49a.77.76-1.8 01-.67.71q-16.89 2.18-34.17 1.45z",
    "M373.75 578.69c-2.47 0-4.31.22-5-2.7-1.8-7.7-3.05-34.29-.19-38.81q.27-.43.77-.47 13.14-1.24 25.77 1.83c8.41 2.04 14.51 3.01 21.85 4.36a1.29 1.28.6 011.05 1.07q2.16 14.12-.73 28.07c-1.08 5.24-5.22 5.26-10.36 5.63q-14.26 1.04-33.16 1.02z",
    "M416.32 584.73q1.14.41 1.07 1.62c-1.62 26.44-9.96 116.68-40.43 126.74-2.27.75-4.15 2.12-6.35 2.73q-1.18.33-1.3-.89-.86-9.2-1.06-17.75c-.83-35.67-.91-71.2-1.01-106.88q0-.5.31-.89c4.95-6.46 41.69-7.25 48.77-4.68z",
  ],
  obliques: [
    "M264.21 435.53c-4.88-3.13-5.75-12.11-5.39-17.36q.03-.53.51-.75 1.8-.84 3.43.85 10.05 10.45 22.57 16.9c3.64 1.89 5.54 3.62 4.79 7.8q-.42 2.35-2.82 1.87-12.45-2.49-23.09-9.31z",
    "M287.33 452.44c-4.05 4.46-10.38 11.38-16.28 14.3a.84.83 51.1 01-.9-.1c-6.29-5.17-12.54-18.97-14.21-25.09q-.91-3.34.85-8.81.12-.39.35-.05c2.41 3.65 4.59 7.74 8.67 9.76q10.18 5.05 21.27 9.01a.61.61 0 01.25.98z",
    "M297.3 487.82c-7.36-4.23-16.68-11.37-20.55-17.57q-.32-.5.09-.92 8.72-9.04 19.84-17.87 1.46-1.17 2.81-1.67a.44.44 0 01.59.43c-.28 10.08-.4 20.42.65 30.43q.34 3.26-.68 6.15a1.9 1.9 0 01-2.75 1.02z",
    "M257.35 456.18l13.68 16.63a1.86 1.82 22.9 01.4.95c.59 5.4-2.02 12.71-3.8 17.56q-.3.84-.84.13-11.85-15.55-9.77-35.17.04-.45.33-.1z",
    "M271.69 494.07a1.53 1.52-61.8 01-.49-1.64l4.2-13.58a.98.98 0 011.51-.5c3.2 2.32 21.89 14.05 22.26 16.7q1.15 8.32.66 16.79a.9.9 0 01-1.34.73q-14.24-8.05-26.8-18.5z",
    "M299.35 544.62c-7.52-6.03-16.15-13.43-24.23-21.24-6.93-6.7-6-17.19-4.88-26.06a.44.44 0 01.72-.28q13.31 11.88 28.41 21.38.43.27.6.75c2.33 6.49.95 18.37-.07 25.23q-.09.59-.55.22z",
    "M299.09 575.53c-7.98-3.65-27.57-15.86-28.06-26.2q-.57-11.91.46-24.3a.36.36 0 01.67-.15q.84 1.36 2.17 2.54 10.59 9.45 21.68 18.31c4.37 3.49 4.34 6.46 4.16 11.74q-.3 8.82-.42 17.64-.01.72-.66.42z",
    "M308.17 657.58c-7.39-.13-12.41-4.13-17.14-9.39q-11.86-13.22-23.92-26.37-.33-.36-.33-.85.09-23.18 1.81-46.22.53-7.13 2.49-14.41a.71.71 0 011.2-.3q11.54 12.06 25.82 21.1 3.36 2.12 3.62 5.17 2.06 23.67 3.86 47.36c.58 7.62 2.31 13.36 4.43 20.82q.47 1.66-.96 2.79-.39.31-.88.3z",
    "M438.7 444.36c-2.09-4.03-.13-6.83 3.63-8.81 10.22-5.36 16.79-11 24.23-18.07a1.71 1.71 0 012.89 1.12c.33 4.74-.81 14.39-5.53 17.22-4.68 2.82-18.74 10.02-24.39 9.14q-.57-.09-.83-.6z",
    "M457.39 466.73c-3.72-1.02-13.2-10.29-16.5-14.49a.52.52 0 01.24-.81q10.94-3.75 21.31-9c3.96-2.01 6.3-5.98 8.57-9.58q.38-.59.55.09c.82 3.33 1.54 6.17.38 9.58-2.55 7.44-7.62 18.79-13.66 24.01a.96.96 0 01-.89.2z",
    "M428.43 487.22c-1.01-1.79-.82-4.55-.71-6.72q.78-15.08.48-30.27-.01-.59.55-.4 1.72.59 3.02 1.64 11.58 9.37 18.82 16.95c3.86 4.05-16.2 17.42-19.56 19.48a1.87 1.86 59.6 01-2.6-.68z",
    "M470.76 456.28a.25.25 0 01.44.13q2.03 19.67-9.8 35.22-.37.48-.6-.08c-1.37-3.29-5.86-16.13-3.51-18.91q6.3-7.47 13.47-16.36z",
    "M452.27 478.5c1.13.49 4.28 12.47 4.78 14.38q.14.5-.23.88-1.29 1.35-2.65 2.41-10.44 8.12-21.76 14.97-1.49.9-2.91 1.33a.81.81 0 01-1.05-.71q-.73-8.62.67-17.15.08-.47.44-.8c1.74-1.6 21.96-15.73 22.34-15.51a.58.03 31 00.37.2z",
    "M428.22 519.14q.11-.36.43-.56 15.3-9.66 28.83-21.69a.43.42-22.6 01.71.29c.51 8.26 2.25 18.67-4.46 25.4q-11.8 11.84-25.03 22.09-.43.34-.49-.2c-.75-6.82-1.97-18.92.01-25.33z",
    "M456.54 524.55a.04.04 0 01.07.02q1.52 13.67.41 27.4-.04.47-.28.88c-4.97 8.3-18.23 19.62-27.88 22.63q-.57.17-.58-.43-.05-10.31-.27-20.53-.1-4.8 2.63-7.09c8.54-7.13 18.56-14.62 25.9-22.88z",
    "M418.89 657.11q-1.12-1.67-.43-3.63 3.27-9.38 4.04-18.23 1.97-22.81 3.58-45.65c.16-2.32.72-6.41 2.84-7.71q14.97-9.23 27.16-21.93.41-.42.71.08 1.29 2.15 1.53 4.2 3.23 27.74 3.13 56.8a1.3 1.28-24.5 01-.33.86q-12.74 13.93-25.55 27.75c-4.8 5.17-9.09 7.87-15.73 7.96q-.61.01-.95-.5z",
  ],
  quads: [
    "M292.42 935.6q-.95-.52-1.57-1.4-4.1-5.79-7-13.53-7.8-20.79-13.3-42.33c-9.06-35.53-19.33-71.36-25.03-107.59-5.33-33.86 4-74.19 20.7-103.37q.35-.62.53.07c14.44 55.57 39.03 107.94 41.45 165.34 1.11 26.34.66 52.96-3.6 79.03-.63 3.83-4.73 27.81-12.18 23.78z",
    "M275.11 942.93q-2.42-2.18-3.57-5.24c-3.98-10.61-7.68-21.02-12.81-31.32-7.85-15.76-10.77-34.56-13.2-51.46-2.11-14.63-2.31-31.47-3.93-47.18-.22-2.16-1.04-12.78.46-13.79q1.36-.92 2.08.55c1.5 3.08 3.12 6.12 3.66 9.58q8.21 52.38 26.36 102.15c2.87 7.87 9.98 30.5 1.85 36.74a.71.7-42.5 01-.9-.03z",
    "M322.69 945.72c-3.73 6.14-10.77-2.43-12.6-5.6-3.16-5.47-2.62-14.93-1.78-20.81 4.03-28.09 5.6-52.81 3.48-80.78q-.06-.79.28-.08 15.77 32.83 14.26 68.9c-.4 9.54-2.94 22.48-2.91 34.13q.01 3.02-.73 4.24z",
    "M437.82 933.52c-8.9 14.18-15.15-26.74-15.46-29.25q-5.26-43.04-1.19-86.08c4.9-51.8 26.91-99.32 40.38-150.92q.18-.66.5-.06c17.25 31.67 25.39 68.28 20.54 104.36q-2.29 17.02-8.71 42.76-7.56 30.25-15.2 60.47-6.13 24.25-15.06 47.61-1.83 4.79-5.8 11.11z",
    "M451.79 942.6c-9.95-10.01 4.97-42.91 8.94-55.41q12.55-39.53 19.27-80.47c.49-2.97 2.64-12.34 5.41-13.28a.83.83 0 011.09.64q.74 4 .45 7.92c-1.99 26.52-3.37 58.99-11.01 87.73q-2.53 9.5-7.46 18.8c-4.38 8.24-6.97 16.72-10.08 25.27q-1.66 4.54-4.55 8.63a1.35 1.35 0 01-2.06.17z",
    "M406.69 946.81c-3.24-2.77-1.48-10.64-2.01-14.71q-2.23-17.18-2.57-22.16c-1.75-25.07 3.61-49.11 13.98-71.92q.23-.51.2.05c-1.2 19.15-1.28 38.18.83 57.38q1.68 15.4 3.39 30.8c.43 3.92-.31 9.71-2.09 13.33-1.62 3.28-7.58 10.77-11.73 7.23z",
  ],
  calves: [
    "M252.09 1032.57c.24-3.71 2.14-22.17 4.63-24.18a1.03 1.02-17.9 011.67.85c-.45 7.89-1.27 16-1.49 23.45q-.57 18.93-.66 37.88-.02 3.63.34 6.85c2.08 18.76 5.56 37.32 9.3 55.8 3.82 18.84 9.13 37.64 13.11 56.63q2.44 11.68 2.08 17.95c-.32 5.7-3.08 20.49-8.51 23.92a.62.62 0 01-.84-.16q-1.2-1.65-.95-3.55c.92-7.26 1.45-14.15-.3-21.52q-8.25-34.74-13.62-59.06c-1.86-8.44-3.17-17.18-3.93-26.3q-3.69-44.24-.83-88.56z",
    "M315.01 1025.17a.16.16 0 01.32.02c4.06 25.75 8.98 52.72 8.71 77.81q-.13 12.06-5.74 26.31c-7.2 18.3-8.93 38.57-15.95 56.93q-.18.48-.21-.03c-1.87-34.47-5.67-65.91-8.56-103.28q-.97-12.49 4.44-23.14 7.47-14.69 15.14-29.29c.81-1.55 1.35-3.62 1.85-5.33z",
    "M455.5 1231.67c-7.13-5.81-9.23-24.34-8.2-31.86 1.41-10.32 4.63-23.14 7.98-36.33q9.54-37.46 15.15-75.74c2.86-19.5 1.53-40.15.75-59.8-.22-5.67-.98-12.51-1.23-18.75a.97.97 0 011.87-.4c.35.86.92 1.76 1.12 2.68q2.96 14.31 3.31 20.53 2.37 43.28-.49 84.75-1.21 17.42-5.43 35.77-6.33 27.51-12.84 54.98-2.01 8.49-.11 18.36c.36 1.9.11 3.95-.68 5.55a.79.79 0 01-1.2.26z",
    "M412.77 1025.44a.14.14 0 01.27-.04c4.88 11.62 10.93 22.01 17.28 34.78 4.07 8.19 4.71 14.41 4.1 24.25-2.13 34.3-6.27 68.85-8.45 101.59q-.05.69-.31.05-1.48-3.67-2.28-6.75c-4.34-16.75-8.78-38.38-16.39-57.57q-1.4-3.55-2.2-10.11c-1.78-14.73-.2-31.24 2.04-45.88q3.06-20.02 5.94-40.32z",
  ],
  adductors: [
    "M280.26 647.4c11.65 10.74 22.18 21.04 31.02 34.3 15.82 23.72 27.55 49.72 34.01 77.58 1.34 5.79-6.14 20.34-12.62 20.22q-.52-.01-.72-.49-.67-1.59-1.21-3.13c-14.68-41.71-27.96-79.71-46.87-117.01-1.9-3.74-3.05-7.33-4.06-11.2a.27.27 0 01.45-.27z",
    "M331.64 898.32q-.17.57-.23-.02c-2.23-25.01-8.47-50.09-14.25-74.53q-19.4-82.1-42.46-163.69-.58-2.08.33-.13c19.88 42.53 38.94 86.51 51.64 132.07 9.49 34.06 15.59 71.67 4.97 106.3z",
    "M334.46 789.17c1.56-2.63 14.39-20.38 16.2-20.37a1.71 1.7-89.2 011.7 1.76q-1.12 34.88-7.4 68.95c-.38 2.06-1.41 4.27-2.16 6.23q-.24.62-.34-.04-3.68-25.45-8.44-50.7c-.34-1.79-.63-4 .44-5.83z",
    "M395.47 779.4c-5.7 1.33-11.34-11.87-12.46-15.86q-.61-2.18-.02-4.65 10.17-42.64 35.06-78.81c9.47-13.77 18.83-22.36 29.85-32.56q.55-.5.4.22-1.12 5.7-3.73 10.83c-19.44 38.38-33.3 79.2-47.77 119.65a1.84 1.83-86.4 01-1.33 1.18z",
    "M453.65 658.99q.67-1.43.23.09-26.73 93.75-48.63 189.74c-1.98 8.7-3.66 17.9-5.44 26.84q-2.19 11.05-2.78 22.43a.15.15 0 01-.3.04c-8.18-24.48-6.74-51.98-1.87-76.86 11.07-56.49 34.44-110.42 58.79-162.28z",
    "M377.91 768.67c1.49.84 1.76 1.49 2.66 2.66q6.16 8.04 12.23 16.13c1.88 2.52 1.97 4.18 1.38 7.45q-4.57 25.23-8.43 50.57-.11.71-.4.05-1.89-4.29-2.54-8.09-5.57-32.28-6.98-65.01-.09-2 .81-3.44a.95.94 30.8 011.27-.32z",
  ],
};

const BACK_MUSCLE_PATHS = {
  traps: [
    "M1071.06 308.94c5.6 4.92 6.96 17.83 7.43 24.88q1.5 22.3.93 44.68-1.2 46.76-5.66 94a.57.56 3.7 01-.59.51q-.68-.03-.94-1.01-4.29-15.9-9.79-25.19c-10.24-17.31-18.8-31.84-25.59-49.4-10.19-26.38-15.6-54.28-26.46-80.58q-3.07-7.43-7.61-14.07-.3-.43.2-.6 12.47-4.28 25.48-4.85c5.54-.25 12.15.86 18.32 1.41 9.7.87 16.77 3.6 24.28 10.22z",
    "M1163.98 302.12a.43.43 0 01.22.65q-7.08 10.77-11.41 23.37c-10.53 30.61-17.8 62.94-31.3 91.07-5.11 10.64-15.17 25.22-20.12 36.26q-4.08 9.08-6.59 18.83a.77.77 0 01-1.51-.12q-4.27-45.15-5.52-90.99c-.56-20.28-.74-39.92 2.75-60.43 1.04-6.13 2.77-9.98 7.85-13.85 9.8-7.48 18.02-7.73 30.1-9.11 12.02-1.39 23.92.4 35.53 4.32z",
  ],
  upper_back: [
    "M987.06 381.44c-8.48-5.06-14.14-13.28-18.82-22.92q-5.3-10.92-6.46-14.04c-1.49-4.01 35.14-19.22 39.61-20.97q2.75-1.08 4.33-.72c4.33.96 6.61 9.96 7.46 13.7q5.43 23.89 14.65 55.74.78 2.7-.88 4.39c-5.37 5.5-34.69-12.08-39.89-15.18z",
    "M1017.44 583.31q-9.11-9.57-16.97-22.03-2.28-3.62-2.91-7.25c-3.28-18.82-5.77-38.04-10.52-56.55-3.53-13.73-4.74-25.19-6.61-41.43-.85-7.35-5.67-13.34-8.22-18.75q-4.93-10.47-6.44-22.88-.33-2.72 1.89-1.11c7.25 5.27 16.36 6.16 26.91 7.56 8.86 1.19 23.41-3.18 28.94-10.76 3.34-4.58 4.7-6.5 8.86-8.77a.67.66-26.4 01.92.3q10.02 21.8 19.93 43.78c2.56 5.69 12.11 15.88 10.77 21.83-3.65 16.09-9.88 31.96-16.24 47.13-9.72 23.21-18.61 46.72-27.2 70.36q-.24.67-.88.35-1.03-.52-2.23-1.78z",
    "M1017.71 404.73c-23.86 13.25-54.31 7.11-60.45-22.75-1.2-5.81-2.5-15.84.64-20.55 3.63-5.44 7.17 4.18 8.17 6.14 7.71 15.14 31.62 29.16 48.2 31.13q1.84.21 5.26 2.06.4.21.26.64-.86 2.65-2.08 3.33z",
    "M1141.45 397.63a2.17 2.14-3.6 01-1.88-1.64q-.71-2.97.18-5.95 8.74-29.19 11.75-43.29c1.73-8.11 3.07-16.77 6.94-22.08 1.92-2.62 4.28-2.27 7.19-1.15q20.52 7.9 39.09 18.77a1.37 1.36 25.9 01.58 1.67c-6.05 15.46-12.98 30.84-28.43 39.45-9.45 5.26-25.83 15.17-35.42 14.22z",
    "M1149.69 404.8q-2.04-1.15-2.45-3.5-.09-.53.41-.75c4.64-2.04 9.78-2.51 14.63-3.87 11.01-3.1 22.03-10.83 30.34-18.57q6.33-5.89 7.58-8.93c1.02-2.49 3.79-9.5 7-9.46q.52.01.87.39 2.71 3.01 2.81 7.2c.33 13.77-2.24 26.93-13.26 35.95-13.88 11.36-33.12 9.94-47.93 1.54z",
    "M1161.19 419.98c6.1 1.57 11.6.99 17.75.06 8.36-1.27 14.83-2.76 21.34-7.27a.54.53 74.1 01.84.47q-.64 11.88-5.76 22.85c-2.42 5.2-6.64 10.84-8.04 16.67q-1.02 4.24-1.43 8.92-1.64 18.72-6.34 37.47c-4.73 18.91-7.13 38.67-10.8 57.85q-.24 1.24-2.2 4.3c-4.57 7.14-12.22 19.43-19.34 23.88a.44.43-25.6 01-.64-.22c-8.26-22.57-16.6-45.11-25.91-67.23-6.67-15.85-13.27-32.14-17.27-48.42q-1.58-6.41 2.91-12.01 5.21-6.51 8.57-14.14 9.25-21 19.01-41.64a.47.47 0 01.65-.21q6.17 3.37 9.51 9.64c2.45 4.6 12.22 7.75 17.15 9.03z",
  ],
  lats: [
    "M987.06 381.44c-8.48-5.06-14.14-13.28-18.82-22.92q-5.3-10.92-6.46-14.04c-1.49-4.01 35.14-19.22 39.61-20.97q2.75-1.08 4.33-.72c4.33.96 6.61 9.96 7.46 13.7q5.43 23.89 14.65 55.74.78 2.7-.88 4.39c-5.37 5.5-34.69-12.08-39.89-15.18z",
    "M1017.44 583.31q-9.11-9.57-16.97-22.03-2.28-3.62-2.91-7.25c-3.28-18.82-5.77-38.04-10.52-56.55-3.53-13.73-4.74-25.19-6.61-41.43-.85-7.35-5.67-13.34-8.22-18.75q-4.93-10.47-6.44-22.88-.33-2.72 1.89-1.11c7.25 5.27 16.36 6.16 26.91 7.56 8.86 1.19 23.41-3.18 28.94-10.76 3.34-4.58 4.7-6.5 8.86-8.77a.67.66-26.4 01.92.3q10.02 21.8 19.93 43.78c2.56 5.69 12.11 15.88 10.77 21.83-3.65 16.09-9.88 31.96-16.24 47.13-9.72 23.21-18.61 46.72-27.2 70.36q-.24.67-.88.35-1.03-.52-2.23-1.78z",
    "M1017.71 404.73c-23.86 13.25-54.31 7.11-60.45-22.75-1.2-5.81-2.5-15.84.64-20.55 3.63-5.44 7.17 4.18 8.17 6.14 7.71 15.14 31.62 29.16 48.2 31.13q1.84.21 5.26 2.06.4.21.26.64-.86 2.65-2.08 3.33z",
    "M1141.45 397.63a2.17 2.14-3.6 01-1.88-1.64q-.71-2.97.18-5.95 8.74-29.19 11.75-43.29c1.73-8.11 3.07-16.77 6.94-22.08 1.92-2.62 4.28-2.27 7.19-1.15q20.52 7.9 39.09 18.77a1.37 1.36 25.9 01.58 1.67c-6.05 15.46-12.98 30.84-28.43 39.45-9.45 5.26-25.83 15.17-35.42 14.22z",
    "M1149.69 404.8q-2.04-1.15-2.45-3.5-.09-.53.41-.75c4.64-2.04 9.78-2.51 14.63-3.87 11.01-3.1 22.03-10.83 30.34-18.57q6.33-5.89 7.58-8.93c1.02-2.49 3.79-9.5 7-9.46q.52.01.87.39 2.71 3.01 2.81 7.2c.33 13.77-2.24 26.93-13.26 35.95-13.88 11.36-33.12 9.94-47.93 1.54z",
    "M1161.19 419.98c6.1 1.57 11.6.99 17.75.06 8.36-1.27 14.83-2.76 21.34-7.27a.54.53 74.1 01.84.47q-.64 11.88-5.76 22.85c-2.42 5.2-6.64 10.84-8.04 16.67q-1.02 4.24-1.43 8.92-1.64 18.72-6.34 37.47c-4.73 18.91-7.13 38.67-10.8 57.85q-.24 1.24-2.2 4.3c-4.57 7.14-12.22 19.43-19.34 23.88a.44.43-25.6 01-.64-.22c-8.26-22.57-16.6-45.11-25.91-67.23-6.67-15.85-13.27-32.14-17.27-48.42q-1.58-6.41 2.91-12.01 5.21-6.51 8.57-14.14 9.25-21 19.01-41.64a.47.47 0 01.65-.21q6.17 3.37 9.51 9.64c2.45 4.6 12.22 7.75 17.15 9.03z",
  ],
  rear_delts: [
    "M980.66 319.58c.19.14.55.19.65.32a.8.8 0 01-.16 1.15c-6.78 4.75-15.26 9.77-20.03 15.58-6.41 7.78-8.76 16.96-9.44 27.04-.39 5.92-1.68 9.5-5.59 13.43-10.02 10.08-19.04 16.47-31.14 20.41q-.75.25-.75-.55.19-18.4-.09-36.3-.14-9.4 1.07-14.22c4.04-16.07 22.8-33.85 39.68-35.64 9.99-1.06 17.34 2.46 25.8 8.78z",
    "M1227.3 316.44c14.62 9.44 25.48 21.03 25.46 39.51q-.02 20.56-.01 41.37a.37.37 0 01-.51.35c-5.08-2.06-10.41-3.98-14.9-6.97-7.84-5.24-21.14-14.95-21.77-24.95-.69-10.75-2.81-20.85-9.76-29.25-4.68-5.65-12.96-10.58-19.6-15.26q-1.23-.87.01-1.71c4.6-3.13 9.91-6.78 15.25-7.98q13.58-3.03 25.83 4.89z",
  ],
  triceps: [
    "M931.03 442.29c-2.01 2.57-6.52 9.71-10.12 9.17q-.52-.08-.8-.52-1.35-2.09-1.84-4.44c-2.25-10.87-3.28-22.88 1.35-33.38 5.45-12.33 18.27-23.68 29.61-31.2a.47.46 68.7 01.71.32l6.42 38.52q.09.54-.26.97c-.47.58-1.12 1.52-1.71 1.94q-9.11 6.58-18.08 13.36-2.9 2.2-5.28 5.26z",
    "M958.15 427.11a.41.41 0 01.55.27q4.44 16.16-2.23 31.41-3.37 7.73-5.91 19.98c-1.51 7.28-8.93 12.21-11.81 18.82-2.42 5.56-2.41 12.5-3.51 16.66-2.14 8.06-8.51 14.15-13.91 20.13a.93.93 0 01-1.54-.25q-.57-1.3-.75-2.89c-1.93-16.91 2.52-33.52 5.71-49.99 2.16-11.21-1.54-24.15 9.68-34.59q9.54-8.86 19.55-17.23c1.3-1.08 2.7-1.72 4.17-2.32z",
    "M903.57 519.67a1.84 1.82-5.4 01-1.12-.92q-3.54-6.97-3.68-15.19c-.37-21.2 3.8-42.53 9.5-63.44q.33-1.23.92-.1 4.64 8.78 8.6 18.67c2.88 7.21 4.19 12.98 1.88 20.57q-6.07 19.96-14.02 39.23-.65 1.58-2.08 1.18z",
    "M1213.94 424.56q-2.02-1.5-3.08-3.02-.31-.46-.22-1 3.32-19.22 6.42-38.46.09-.56.56-.25 14.9 9.82 24.8 22.71c9.8 12.75 9.72 30.37 5.41 45.13a2.62 2.62 0 01-3.76 1.57c-3.26-1.77-6.22-6.71-8.62-9.67-5.24-6.46-14.75-12-21.51-17.01z",
    "M1246.2 534.5q-.95-.3-1.75-1.22c-4.65-5.4-9.13-9.88-11.46-15.51-2.96-7.13-1.37-15.5-5.64-22.09-4.06-6.26-8.72-9.91-10.89-17.58-1.62-5.68-2.81-11.46-4.97-17.02-4.56-11.69-6.45-20.86-3.33-33.56a.59.58-74 01.75-.42q1.69.56 3.22 1.79 11.23 9.08 21.54 19.18c5.39 5.28 6.92 10.13 7.24 18.16.9 22.52 10.62 44.97 6.59 67.49a1.01 1 13.9 01-1.3.78z",
    "M1258.43 439.96q2.01 5.38 3.1 10.68c3.58 17.36 7.13 34.77 6.89 52.61q-.11 8.3-3.94 15.61a1.61 1.6 33.4 01-2.44.5c-1.45-1.19-1.9-3.58-2.43-4.94q-9.23-23.41-13.19-38.15c-2.63-9.81 6.82-27.63 11.53-36.35q.28-.5.48.04z",
  ],
  lower_back: [
    "M986.76 627.1c-3.13-13.13-7.31-49.77 7.27-58.07 2.4-1.37 4.8-.82 6.7 1.29 6.15 6.8 16.22 18.56 18.77 28.15a1.35 1.3 52.6 01-.11.98c-2.51 4.53-9.96 8.09-15.83 11.36q-5.47 3.06-11.33 10.52c-1.23 1.56-2.6 4.3-4.5 6.06a.59.58-28.2 01-.97-.29z",
    "M1023.15 607.96a2.06 2.04-74.3 01-.94-1.69c-.17-10.98 5.04-24.58 8.79-34.9q15.61-42.83 36-83.59a1.11 1.1-62.5 011.51-.48c1.25.66 3.21 12.98 3.46 15.08q6.94 59.25 2.82 116.88-.62 8.66-3.1 19.37-.13.53-.59.24l-47.95-30.91z",
    "M1090.76 581.75q.62-5.16 0-10.27.22-29.79 3.05-59.5 1.1-11.58 3.91-22.88.31-1.27.44-1.43 1.08-1.43 1.88.17 23.38 46.97 40.14 96.18c1.8 5.28 5.84 16.69 4.38 22.96a1.64 1.64 0 01-.71 1.01l-47.63 30.72q-1.12.72-1.34-.6-4.54-28-4.12-56.36z",
    "M1151.19 603.31q-5.39-3.38-2.19-9.05 8.03-14.22 17.88-24.62c3.49-3.69 9.04.89 10.97 3.99q2.92 4.66 3.8 10.14 3.5 21.77-1.21 43.02a.96.96 0 01-1.77.28c-6.92-11.85-16.03-16.56-27.48-23.76z",
  ],
  glutes: [
    "M1045.06 626.19q1.42.61 4.11 4.4.27.39-.19.52c-14.47 4.12-26.13 7.4-38.13 15.77q-15.37 10.71-30.53 21.6a.55.54 74.9 01-.86-.5c1.19-13.13 10.35-35.23 20.46-45.06 9.14-8.88 34.99-1.11 45.14 3.27z",
    "M1007.94 762.81c-16.94-16.64-29.37-37.66-31.47-61-2.06-22.84 15.63-34.95 32.18-45.71 8.2-5.33 46.51-27.32 54.37-17.65 5.92 7.29 13.38 15.84 15.44 25.21q3.01 13.63 2.44 27.6-.94 22.59-6.27 44.49c-2.43 9.96-2.9 17.16-2.59 26.75.47 14.83-18.52 17.18-29.12 14.07-6.38-1.87-13.79-4.83-21.35-6.25q-7.39-1.38-13.63-7.51z",
    "M1117.94 631.04q-.13-.03-.27-.06-.12-.02-.06-.13 2.58-4.2 7.05-5.92 12.71-4.87 26.13-5.81c12.93-.91 17.1 3.08 23.28 13.06 5.71 9.22 13.32 24.7 13.44 36.06q.01.76-.61.32-16.65-11.74-33.2-23.51c-10.03-7.14-23.72-10.58-35.76-14.01z",
    "M1124.12 776.61c-9.28 2.74-26.75 1.29-28.86-10.88-1.05-6.03.27-14.88-1.3-23.27q-.54-2.94-2.15-9.35c-3.2-12.81-4.02-23.33-5.08-35.27-1.07-12.03-.57-22 1.64-33.17q1.1-5.6 4.19-10.41 8.74-13.58 11.87-16.59c4.96-4.77 15.84.18 21.19 2.11q19.7 7.12 40.17 21.43c9.59 6.7 19.29 14.31 22.93 25.17 4.81 14.37-.65 33.88-7.42 46.87q-7.79 14.97-21.39 28.9-6.74 6.9-15.26 8.36c-7.07 1.21-13.68 4.08-20.53 6.1z",
  ],
  hamstrings: [
    "M963.27 741.53a.71.7 31.7 011.19-.28q1.51 1.62 2.47 3.99c4.6 11.41 8.93 22.66 11.07 34.72 3.38 19.14 4.84 38.23 3.12 57.74q-1.68 19.06-2.99 38.15c-.51 7.55-.88 15.71.07 23.18q1.08 8.54 1.39 17.57a.52.52 0 01-.98.25q-1.03-2.07-1.8-4.62-5.13-16.92-7.25-34.49-5.01-41.45-6.86-83.17-1.09-24.75-.07-49.51.06-1.59.64-3.53z",
    "M1030.2 791.53q.17-.36.38-.03c5.26 8.11 9.94 16.15 12.47 25.64 3.12 11.72 5.87 24.36 4.31 36.24q-.5 3.8-3.57 14.02c-10.75 35.81-12.83 74.2-18.5 111.1q-.82 5.4-2.55 10.55-.23.68-.59.07c-4.72-8.07-5.18-25.09-5.34-34.81-.7-43.69 1.92-87.82 6.38-131.28 1.41-13.74 1.99-21.15 7.01-31.5z",
    "M998.81 761.94q14.07 14.17 20.1 33.62c.98 3.15-.78 9.61-.93 12.91q-1.3 27.63-2.3 55.27c-.55 15.31-1.54 30.27-5.12 45.26q-8.62 36.18-22.76 68.73-3.65 8.41-10.15 17.19-.45.61-.41-.14c.11-1.93.82-4.15.99-5.71q2.45-22.72 6.08-45.26c2.83-17.66 4.18-35.95 4.33-52.37.33-36.43-.75-73.34 1.47-109.68.33-5.32 1.07-16.16 4.7-20.25q.33-.36.81-.45 1.95-.37 3.19.88z",
    "M1052.52 855.62a.04.04 0 01.08.01q1.07 9.9 2.17 19.87.33 3.04-2.37 14.18c-3.83 15.8-8.15 31.11-8.9 47.47-.99 21.61-3.11 45.66-9.92 66.3q-1.49 4.52-.87-.2 3.38-25.36 3.7-51.99c.05-3.74-.4-10.32.2-15.58 2.19-19.2 7.39-38.25 11.75-57.05 1.78-7.64 2.93-15.21 4.16-23.01z",
    "M1183.25 947.53c2.57 14.85 4.32 31.11 6.22 46.14q.35 2.74-1.11.39c-14.67-23.67-23.34-52.15-30.55-79.32q-5.08-19.14-5.97-39.05-1.36-30.37-2.44-60.74c-.22-6.09-2.56-15.63-.55-21.57q5.87-17.35 18.96-31.07c10.77-11.28 10.17 46.55 10.16 48.97-.13 41.09-.45 74.18 1.91 110.07.57 8.75 1.88 17.53 3.37 26.18z",
    "M1136.43 791.52q.27-.42.49.03c3.12 6.46 4.84 12.26 5.68 19.83 5.07 45.8 8.05 94.61 7.56 140.76-.13 11.8-.46 26.22-5.13 37.08a.44.44 0 01-.83-.06q-2.51-9.14-3.69-18.41-3.54-27.64-7.36-55.24c-2.49-18-5.47-35.67-11.09-52.26q-4.35-12.82-2.08-26.75c1.76-10.77 3.58-21.61 8.46-31.16q3.58-6.99 7.99-13.82z",
    "M1115.03 856.73c2.03 18.72 7.11 37.44 11.47 55.77 2.25 9.46 3.94 19.51 3.95 30.11q.02 31.7 4.08 63.16.16 1.26-.29.07-2.7-7.15-4.19-14.6c-4.44-22.21-5.71-40.52-6.87-61.23-.24-4.24-1.19-9.64-2.23-13.92q-3.94-16.25-7.7-32.55c-2.09-9.04.08-18.69 1.6-27.66q.07-.38.32-.09.16.19.01.4-.19.24-.15.54z",
    "M1202.61 741.08a.44.44 0 01.72.03c.52.82.9 1.86.95 2.91q.73 15.98.37 31.97-1.16 52.95-7.85 105.49-1.88 14.74-5.97 29.04-1 3.52-1.92 4.95-1.57 2.47-1.39-.37c.58-9.44 1.83-19.17 1.71-28.16-.32-24.52-4.94-49.11-3.95-72.75.69-16.54 2.5-33.51 7.54-49.38q2.99-9.4 6.61-18.6.74-1.88 3.18-5.13z",
  ],
  calves: [
    "M982.69 1149.31c-3.07-2.23-3.98-6.24-5.24-11.03-7.19-27.14-7.88-53.18-6.67-82.78q1.03-25.29 9.23-47.45c4.77-12.89 15.33-24.77 23.79-36q.82-1.09.74.27c-1.37 22.86-2.72 45.67-3.11 68.49-.52 30.56-1.51 61.11-.42 91.68.24 6.83-2.77 16.29-10.08 18.37q-4.39 1.25-8.24-1.55z",
    "M983.99 1163.56c7.15-5.59 16.16-.63 17 8.23q4.31 45.02 5.22 90.26c.16 8.25-.8 15.79-2.19 23.65q-.45 2.52-1.43 3.66-.95 1.11-1.22-.33c-5.03-26.7-8.28-53.49-11.87-80.36q-1.68-12.52-3.24-18.71-2.04-8.12-5.53-18.24c-1.03-3 .8-6.25 3.26-8.16z",
    "M1013.69 1150.31c-4.8-2.61-4.66-16.17-4.36-20.75 2.34-36.49 3.44-73.94 1.04-110.45-1.03-15.55.02-31.49.62-47.06q.03-.66.25-.03c2.28 6.45 4.52 12.88 7.39 19.11 5.12 11.14 11.5 22.91 14.83 33.92q2.34 7.74 3.97 16.46 5.3 28.43 5.62 56.09c.2 18.32-7.9 40-22.63 51.79q-3.42 2.73-6.73.92z",
    "M1014.14 1164.37c7-1.83 14.1 2.2 14.11 9.95q.06 29.04-5.62 57.41c-3.87 19.28-6.24 38.23-8.43 57.48a.37.37 0 01-.74-.01q-3.12-43.48-3.58-86.64-.15-14.16.76-28.3c.18-2.83.02-8.98 3.5-9.89z",
    "M1172.94 1149.31c-6.06-4.56-6.94-11.4-6.8-19.4.96-52.67-.49-105.31-3.54-157.9q-.04-.72.41-.16 7.96 10.07 15.43 20.44c9.11 12.64 13.61 28.98 15.78 44.21 4.96 34.71 3.75 72.94-5.97 106.5-1.97 6.82-9.18 10.93-15.31 6.31z",
    "M1144.41 1147.33q-17.19-17.37-20.08-40.86-.89-7.22-.13-19.97 1.18-20.06 4.69-41.33c2.33-14.1 5.8-25.22 12.41-38.61q8.19-16.59 14.35-34.15a.14.13-37.7 01.26.03q1.01 15.71 1.26 31.44c.18 11.61-1.34 24.91-1.58 36.43-.72 34.7 1.22 62.05 2.06 93.19.17 6.32-1.1 26.1-13.24 13.83z",
    "M1173.74 1161.73c6.88-2 14.34 3.23 11.98 10.91-2.24 7.3-4.78 14.44-5.99 21.96-5.07 31.52-8.04 63.18-14.13 94.6a.72.71-61.9 01-1.21.37c-.14-.14-.35-.39-.4-.59q-3.53-13.58-3.19-28.23 1.04-44.67 5.06-87.04c.58-6.1 1.93-10.25 7.88-11.98z",
    "M1154.32 1165a1.58 1.57-84.6 01.97 1.18c.79 4.42 1.42 8.78 1.57 13.4.96 29.17-.47 62.66-2.04 90.23q-.78 13.79-1.39 19.52a.23.23 0 01-.45 0c-2.79-21.25-5.41-41.99-9.64-63.03-3.44-17.08-4.29-34.91-4.68-52.3-.19-8.37 8.99-11.61 15.66-9z",
  ],
  forearms: [
    "M878.44 534.38a.15.15 0 01.18-.13c.47.12 6.68 15.77 7.07 17.22q6.66 24.73 5.52 50.29c-.4 8.9-3.45 17.35-6.64 25.55-7.94 20.38-17.41 41.88-29.59 60.09a1.04 1.02-54.2 01-1.49.25c-.34-.26.37-1.45.47-1.83q5.58-20.8 8.97-42.08 8.65-54.15 15.51-109.36z",
    "M893 518.93a.39.38 24.6 01.69-.25q5.97 7.83 13.11 15.27c8.08 8.4 1.41 28.73-5.88 37.12a1.05 1.05 0 01-1.63-.05c-6.09-7.93-5.41-18.74-4.97-28.44.36-8.12-.76-15.7-1.32-23.65z",
    "M869.06 547.19c2.16.36 1.67 6.21 1.57 7.8q-2.54 38.84-9.11 77.16c-3.04 17.71-8.47 41.3-22.09 54.09a.38.38 0 01-.62-.41c14.51-40.44 19-84.26 26.8-126.31q.9-4.88 1.48-10.82.18-1.81 1.97-1.51z",
    "M864.24 682.58q15.09-28.18 25.12-58.55c8.14-24.63 13.67-42.4 20.79-60.35q3.31-8.37 12.08-9.63c1.35-.2 3.68-.75 4.86.21q1.13.93.61 2.3-5.8 15.45-12.04 29.88c-5.79 13.39-14.92 28.68-20.32 40.14-6.12 13-28.07 59.18-31.64 56.64a.21.21 0 01.03-.36q.15-.07.34-.13.12-.04.17-.15z",
    "M1272.99 519.43c.27-.33.33-.75.75-1.05a.32.32 0 01.5.29c-.7 7.22-1.77 14.33-1.66 21.54.13 8.94 2.13 24-5.35 31.17q-.37.35-.73 0c-7.63-7.55-14.2-28.29-6.52-36.92q6.6-7.41 13.01-15.03z",
    "M1312.82 688.04c-4.78-6.01-7.2-10.8-11.76-19.56q-12.39-23.79-21.03-47.53c-4.86-13.36-5.22-26.17-3.83-40.19q1.13-11.5 2.69-19.53 2.72-13.98 9.59-26.79a.17.17 0 01.32.06q7.26 63.12 17.22 120.49 2.43 14.04 7.03 30.55c.22.79.74 1.33.36 2.4a.34.34 0 01-.59.1z",
    "M1296.52 558.51c-.22-2.94-1.44-10.25 2-12.04a.62.61-18.4 01.89.44q6.25 35.69 12.21 71.07c3.88 23 8.77 46.2 16.73 68.19a.29.29 0 01-.47.31c-11.67-10.67-18.09-31.15-20.89-45.98q-7.27-38.55-10.47-81.99z",
    "M1303.5 683.6c-2.89-.66-10.16-13.21-12.11-17.02-8.8-17.21-16.92-34.81-25.84-51.89-5.36-10.27-10.98-20.49-15.39-30.95q-5.86-13.86-11.07-27.8a1.63 1.62 79.5 011.5-2.2c13.02-.16 15.5 7.18 19.65 18.81q9.04 25.33 17.43 50.89 9.65 29.37 23.82 56.84.87 1.69 2.13 3.12.24.28-.12.2z",
  ],
  adductors: [
    "M1070.06 785.19c2.95 1.36 1.8 10.43 1.49 13.04q-3.98 33.27-14.66 64.61a.39.39 0 01-.76-.17c.9-7.05 2.31-14.29 2.16-20.92q-.68-30.14-18.71-54.52-.29-.39.18-.49c7.42-1.52 23.53-4.69 30.3-1.55z",
    "M1127.24 787.66c-15.99 21.49-22.3 48.51-16.08 74.83a.47.46-63.2 01-.88.29q-1.99-4.69-3.65-10.24-8.29-27.75-11.6-56.54c-.65-5.71-1.1-11.77 6.87-11.9q13-.19 25.68 2.83a.31.24 41.2 01.1.53q-.12.01-.27.07-.1.04-.17.13z",
  ],
};

const FRONT_OUTLINE = 'M 309.48 168.91 Q 305.84 163.85 304.37 158.56 298.37 135.67 310.41 114.37 C 319.01 99.18 340.13 90.17 356.3 86.68 362.96 85.24 370.02 85.62 376.76 85.68 395.55 85.86 403.9 90.89 420.22 99.27 C 437.84 108.33 441.57 124.52 444.51 142.52 446.19 152.82 442.58 164.89 438.69 174.33 Q 438.35 175.16 438.42 175.77 440.18 190.16 440.04 204.66 Q 439.88 221.85 437.23 238.89 436.87 241.22 437.87 242.77 444.64 253.28 457.88 257.86 C 474.06 263.46 493.49 264.94 501.72 282.22 Q 508.02 295.44 507.65 311.15 L 514.84 321.68 C 521.75 322.32 527.04 328.23 530.41 333.27 533.97 338.61 536.53 344.9 537.53 351.41 Q 542.41 382.84 530.11 412.45 C 528.1 417.29 525.94 423.14 522.85 427.25 L 517.74 434.05 Q 518.83 447.08 519 462.88 517.97 475.98 517.51 489.3 516.19 527.26 528.14 561.13 L 542.07 600.66 Q 548.89 621.21 552.8 642.77 C 563.42 701.38 575.03 759.21 580.28 818.46 585.58 878.26 583.67 940.72 578.72 1000.27 Q 575.99 1033.1 571.49 1065.69 568.91 1084.33 565.48 1102.82 563.07 1115.81 558.87 1128.4 554.37 1141.89 549.72 1155.29 548.73 1158.13 546.23 1160.25 537.49 1167.65 535.04 1175.62 Q 530.16 1191.46 523.5 1210.2 519.66 1221.04 512.46 1229.93 500.41 1244.81 489.88 1260.02 L 488 1267.75 488 1282.96 Q 487.63 1293.14 486.51 1303.26 L 482.41 1318.67 Q 465.92 1315.83 449.91 1311.33 432.63 1306.47 415.15 1302.21 L 363.22 1301.9 Q 356.6 1303.07 350.07 1304.77 C 328.47 1310.38 307.18 1317.61 285.35 1322.29 Q 281.44 1323.13 277.03 1321.7 273.35 1320.5 272.46 1316.2 271.29 1310.56 270.42 1304.86 L 267.26 1282.38 Q 266.38 1267.24 264.33 1252.43 C 261.44 1232.08 250.84 1212.27 243.01 1193.62 236.42 1177.9 233.69 1163.53 228.51 1147.06 218.4 1114.88 208.63 1080.64 201.76 1047.58 Q 196.12 1020.39 193.85 992.63 C 189.49 939.33 181.98 886.44 183.51 832.83 184.42 800.69 191.04 741.82 205.54 690.02 212.69 664.49 216.53 639.08 221.59 613.02 Q 225.75 591.59 232.24 570.64 235.69 559.5 238.01 548.06 243.06 523.14 239.62 498.45 L 234.8 468.75 Q 234.04 457.06 234.44 445.27 L 229.77 438.11 C 226.15 433.59 224.1 427.44 221.85 422.23 Q 210.32 395.52 213.79 366.25 C 216.63 342.32 220.57 330.51 241.69 321.43 L 241.5 311.24 Q 240.8 293.5 247.83 278.18 256 260.37 277.2 255.99 289.51 253.45 295.67 247.16 Q 305.4 237.21 309.2 224.06 314.24 206.62 314.42 188.01 L 309.48 168.91 Z';
const BACK_OUTLINE = 'M 1028.14 166.45 Q 1025.3 161.5 1025.07 155.76 1024.33 138.69 1029.77 122.6 C 1037.48 99.78 1058.19 88.73 1080.49 86.79 1088.29 86.11 1096.35 85.62 1104.04 86.86 1133.15 91.47 1152.6 102.21 1164.03 129.72 Q 1167.43 137.88 1168.42 146.89 1169.7 158.55 1167.98 170.07 L 1162.96 189.59 Q 1163.82 208.12 1160.96 226.43 1160.07 232.18 1158.2 237.48 1154.34 248.44 1145.13 255.41 Q 1140.31 259.06 1138.23 260.18 C 1149.97 263.02 1161.24 265 1171.09 273.06 Q 1180.44 280.71 1186.58 290.08 1194.67 302.43 1196.87 318.17 L 1197.74 325.82 Q 1203.67 326.47 1208.07 328.13 C 1215.37 330.89 1218.36 337.93 1221 345.02 Q 1230.61 370.8 1232.96 396.33 1234.33 411.19 1233.2 425.81 L 1229.63 438.85 1234.66 446.59 Q 1236.98 454.84 1237.73 466.36 L 1237.26 490.46 Q 1233.28 525.08 1241.1 558.66 1244.15 571.82 1249.66 584.16 L 1285.81 676.46 Q 1294.1 706.26 1301.72 736.35 C 1308.37 762.59 1312.46 789.05 1316.96 815.73 Q 1323.39 853.86 1326.81 892.47 1329.7 925.08 1329.56 957.88 L 1327.81 1007.67 Q 1326.27 1032.66 1322.65 1057.45 1321.07 1068.29 1318.82 1079.01 1315.89 1092.94 1312.25 1106.7 L 1305.41 1130.49 C 1300.5 1143.31 1294.72 1155.9 1291.1 1169.15 L 1278.04 1211.2 Q 1268.28 1231.57 1253.76 1249.94 L 1246.13 1258.64 Q 1245.58 1269.86 1244.37 1280.99 1242.87 1294.82 1241.27 1308.15 L 1235.07 1322.11 Q 1214.45 1318.99 1194.8 1313.51 1178.96 1309.09 1163.15 1304.42 L 1105.96 1302.28 Q 1089.28 1305.79 1072.83 1310.13 1055.14 1314.82 1037.47 1319.59 L 1026.44 1321.67 Q 1020.99 1319.56 1017.58 1314.62 1015.67 1311.86 1015.68 1308.54 L 1015.26 1267.43 C 1012.15 1256.94 1007.53 1247.37 1002.21 1237.84 997.84 1230.01 994.73 1222.29 991.39 1213.79 Q 982.48 1191.05 976.29 1166.93 974.09 1158.35 970.96 1150.2 L 959.29 1120.6 Q 955.29 1106.69 952.15 1092.57 948.35 1075.48 945.55 1058.17 942.66 1040.32 940.58 1022.35 937.57 996.36 936.13 970.22 935.73 962.86 935.59 955.49 934.93 927.64 936.85 899.93 938.28 879.3 939.12 858.66 939.65 845.43 942.16 832.39 944.63 819.59 945.76 806.44 947 793.94 946.6 781.39 945.64 751.59 942.58 722.04 Q 939.4 690.98 934.35 660.16 931.65 643.74 926.79 627.79 L 920.09 607.81 Q 916.87 595.96 913.07 584.29 910.68 576.96 909.44 569.32 907.34 556.36 910.59 543.18 L 918.97 500.64 Q 919.17 490.18 918.63 479.68 917.82 465.38 918.84 451.25 919.09 447.85 920.39 443.4 L 915.91 436.38 C 912.89 432.54 910.35 427.56 908.18 423.07 Q 896.53 398.97 899.08 372.07 901.53 346.13 912.91 322.63 914.01 320.37 915.91 318.91 L 916.37 308.85 Q 915.98 289.59 925 274.4 C 938.65 251.45 963.64 257.56 981.62 257.56 Q 987.46 243.01 989.2 227.69 990.82 213.41 990.28 198.96 L 989.96 189.13 1028.14 166.45 Z';

function getMuscleClass(muscleId, planned, completed, partial) {
  if (completed.includes(muscleId)) return 'completed';
  if (partial.includes(muscleId)) return 'partial';
  if (planned.includes(muscleId)) return 'planned';
  return '';
}

function MuscleMapSVG({ view, planned, completed, partial, paths, outline, viewBox }) {
  return html`
    <div class="muscle-view">
      <div class="view-label">${view}</div>
      <svg viewBox="${viewBox}">
        ${Object.entries(paths).map(([muscleId, pathList]) =>
          pathList.map(d => html`
            <path
              d="${d}"
              class="muscle-region ${getMuscleClass(muscleId, planned, completed, partial)}"
            />
          `)
        )}
      </svg>
    </div>
  `;
}

function MuscleMap({ planned = [], completed = [], partial = [], mini = false }) {
  return html`
    <div class="muscle-map-container ${mini ? 'mini' : ''}">
      <${MuscleMapSVG}
        view="FRONT"
        planned=${planned}
        completed=${completed}
        partial=${partial}
        paths=${FRONT_MUSCLE_PATHS}
        outline=${FRONT_OUTLINE}
        viewBox="120 60 500 1300"
      />
      <${MuscleMapSVG}
        view="BACK"
        planned=${planned}
        completed=${completed}
        partial=${partial}
        paths=${BACK_MUSCLE_PATHS}
        outline=${BACK_OUTLINE}
        viewBox="850 60 500 1300"
      />
    </div>
    <div class="legend">
      <div class="legend-item"><div class="legend-dot" style="background:var(--accent-blue)"></div> Planned</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--accent-amber)"></div> In Progress</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--accent-green)"></div> Completed</div>
    </div>
  `;
}

// ═══════════════════════════════════════════════════════════════
// SECTION 6: REDUCER
// ═══════════════════════════════════════════════════════════════

const defaultState = {
  screen: 'start',
  activeSession: null,
  sessions: [],
  exerciseHistory: {},
  settings: { weightUnit: 'lbs', lastLockerNumber: '' },
  lastProgramId: null,
  expandedExercise: 0,
  detailView: null,
  // 5/3/1 fields
  trainingMaxes: {},   // { squat: 200, bench_press: 150, ... }
  cycleWeek: 1,        // 1-4
  cycleNumber: 1,      // increments after week 4
  // Rest timer
  restTimer: null,     // { seconds, remaining, active }
};

function initState() {
  const saved = loadState();
  if (!saved) return defaultState;
  return {
    ...defaultState,
    sessions: saved.sessions || [],
    exerciseHistory: saved.exerciseHistory || {},
    settings: saved.settings || defaultState.settings,
    lastProgramId: saved.lastProgramId || null,
    activeSession: saved.activeSession || null,
    screen: saved.activeSession ? 'workout' : 'start',
    trainingMaxes: saved.trainingMaxes || {},
    cycleWeek: saved.cycleWeek || 1,
    cycleNumber: saved.cycleNumber || 1,
  };
}

function appReducer(state, action) {
  switch (action.type) {
    case 'START_SESSION': {
      const { startTime, lockerNumber, programId, cardio } = action;
      const exercises = build531Exercises(programId, state.cycleWeek, state.trainingMaxes, state.exerciseHistory);
      return {
        ...state,
        screen: 'workout',
        expandedExercise: 0,
        restTimer: null,
        activeSession: {
          id: 'session_' + Date.now(),
          date: todayStr(),
          startTime,
          startTimestamp: Date.now(),
          endTime: null,
          duration: null,
          lockerNumber,
          programId,
          cycleWeek: state.cycleWeek,
          cycleNumber: state.cycleNumber,
          cardio: cardio || null,
          exercises,
        },
        settings: { ...state.settings, lastLockerNumber: lockerNumber },
      };
    }

    case 'UPDATE_SET': {
      const { exerciseIndex, setIndex, field, value } = action;
      const session = { ...state.activeSession };
      const exercises = session.exercises.map((e, ei) => {
        if (ei !== exerciseIndex) return e;
        const sets = e.sets.map((s, si) => {
          if (si !== setIndex) return s;
          return { ...s, [field]: value };
        });
        return { ...e, sets };
      });
      return { ...state, activeSession: { ...session, exercises } };
    }

    case 'ADD_EXERCISE': {
      const { exerciseId, sets, reps } = action;
      const session = { ...state.activeSession };
      const next = state.exerciseHistory ? calculateNextWeight(exerciseId, state.exerciseHistory) : null;
      const weight = next ? next.weight : 0;
      const newExercise = {
        exerciseId,
        category: 'accessory',
        label: 'Custom',
        sets: Array.from({ length: sets || 3 }, () => ({
          weight,
          reps: reps || 10,
          targetReps: reps || 10,
          completed: false,
        })),
      };
      return { ...state, activeSession: { ...session, exercises: [...session.exercises, newExercise] } };
    }

    case 'REMOVE_EXERCISE': {
      const session = { ...state.activeSession };
      const exercises = session.exercises.filter((_, i) => i !== action.exerciseIndex);
      return { ...state, activeSession: { ...session, exercises }, expandedExercise: 0 };
    }

    case 'SET_EQUIPMENT': {
      const session = { ...state.activeSession };
      const exercises = session.exercises.map((e, ei) => {
        if (ei !== action.exerciseIndex) return e;
        return { ...e, equipment: action.equipment };
      });
      return { ...state, activeSession: { ...session, exercises } };
    }

    case 'TOGGLE_SET_COMPLETE': {
      const { exerciseIndex, setIndex } = action;
      const session = { ...state.activeSession };
      const exercises = session.exercises.map((e, ei) => {
        if (ei !== exerciseIndex) return e;
        const sets = e.sets.map((s, si) => {
          if (si !== setIndex) return s;
          return { ...s, completed: !s.completed };
        });
        return { ...e, sets };
      });
      // Auto-start rest timer when set completed
      const wasCompleted = session.exercises[exerciseIndex].sets[setIndex].completed;
      const nowCompleted = !wasCompleted;
      const ex = EXERCISES[session.exercises[exerciseIndex].exerciseId];
      const isCompound = ex && ex.category === 'compound';
      const defaultRest = isCompound ? 180 : 90; // 3min compounds, 1.5min accessories
      return {
        ...state,
        activeSession: { ...session, exercises },
        restTimer: nowCompleted ? { seconds: defaultRest, remaining: defaultRest, active: true } : state.restTimer,
      };
    }

    case 'SET_EXPANDED': {
      return { ...state, expandedExercise: action.index };
    }

    case 'REST_TIMER_TICK': {
      if (!state.restTimer || !state.restTimer.active) return state;
      const remaining = state.restTimer.remaining - 1;
      if (remaining <= 0) return { ...state, restTimer: { ...state.restTimer, remaining: 0, active: false } };
      return { ...state, restTimer: { ...state.restTimer, remaining } };
    }

    case 'REST_TIMER_SET': {
      return { ...state, restTimer: { seconds: action.seconds, remaining: action.seconds, active: true } };
    }

    case 'REST_TIMER_DISMISS': {
      return { ...state, restTimer: null };
    }

    case 'END_SESSION': {
      const endTimestamp = Date.now();
      const duration = state.activeSession.startTimestamp
        ? Math.floor((endTimestamp - state.activeSession.startTimestamp) / 1000)
        : null;
      const session = { ...state.activeSession, endTime: nowTimeStr(), duration };
      const newHistory = { ...state.exerciseHistory };

      session.exercises.forEach(se => {
        const maxWeight = Math.max(...se.sets.map(s => s.weight));
        const allCompleted = se.sets.every(s => s.completed && s.reps >= (s.targetReps || 0));
        newHistory[se.exerciseId] = updateExerciseHistory(
          newHistory, se.exerciseId, maxWeight, allCompleted, session.date
        );
      });

      return {
        ...state,
        screen: 'start',
        activeSession: null,
        restTimer: null,
        sessions: [...state.sessions, session],
        exerciseHistory: newHistory,
        lastProgramId: session.programId,
      };
    }

    case 'SET_TRAINING_MAX': {
      return {
        ...state,
        trainingMaxes: { ...state.trainingMaxes, [action.exerciseId]: action.weight },
      };
    }

    case 'ADVANCE_CYCLE': {
      const nextWeek = state.cycleWeek >= 4 ? 1 : state.cycleWeek + 1;
      const nextCycle = state.cycleWeek >= 4 ? state.cycleNumber + 1 : state.cycleNumber;
      // Auto-increase TMs after full cycle (week 4 → week 1)
      let newTMs = { ...state.trainingMaxes };
      if (state.cycleWeek >= 4) {
        MAIN_LIFTS.forEach(lift => {
          if (newTMs[lift]) {
            const inc = (lift === 'squat' || lift === 'deadlift') ? 10 : 5;
            newTMs[lift] = newTMs[lift] + inc;
          }
        });
      }
      return { ...state, cycleWeek: nextWeek, cycleNumber: nextCycle, trainingMaxes: newTMs };
    }

    case 'SET_CYCLE_WEEK': {
      return { ...state, cycleWeek: action.week };
    }

    case 'NAVIGATE': {
      return { ...state, screen: action.screen, detailView: null };
    }

    case 'VIEW_DETAIL': {
      return { ...state, detailView: action.detail };
    }

    case 'BACK_FROM_DETAIL': {
      return { ...state, detailView: null };
    }

    case 'IMPORT_EXERCISE_HISTORY': {
      const merged = { ...state.exerciseHistory };
      Object.entries(action.data).forEach(([exId, imported]) => {
        const existing = merged[exId] || { lastWeight: 0, lastCompleted: false, consecutiveFailures: 0, history: [] };
        const existingDates = new Set(existing.history.map(h => h.date));
        const newEntries = imported.history.filter(h => !existingDates.has(h.date));
        const combined = [...existing.history, ...newEntries]
          .sort((a, b) => new Date(b.date) - new Date(a.date))
          .slice(0, 50);
        const latest = combined[0];
        merged[exId] = {
          lastWeight: latest ? latest.weight : existing.lastWeight,
          lastCompleted: latest ? latest.allCompleted : existing.lastCompleted,
          consecutiveFailures: existing.consecutiveFailures,
          history: combined,
        };
      });
      return { ...state, exerciseHistory: merged };
    }

    case 'RESET_APP': {
      localStorage.removeItem('ironlog_v2');
      localStorage.removeItem('ironlog_v1');
      return { ...defaultState, screen: 'start' };
    }

    default:
      return state;
  }
}

// ═══════════════════════════════════════════════════════════════
// SECTION 7: COMPONENTS
// ═══════════════════════════════════════════════════════════════

// --- Stepper (for weight) with tap-to-type ---
function WeightStepper({ value, onChange, showPlates, equipment }) {
  const [editing, setEditing] = useState(false);
  const [editVal, setEditVal] = useState('');
  const inputRef = useRef(null);

  const startEdit = () => {
    setEditVal(String(value));
    setEditing(true);
  };

  useEffect(() => {
    if (editing && inputRef.current) inputRef.current.focus();
  }, [editing]);

  const commitEdit = () => {
    const num = parseFloat(editVal);
    if (!isNaN(num)) onChange(num);
    setEditing(false);
  };

  const plates = showPlates ? calculatePlates(value) : [];

  return html`
    <div>
      <div class="stepper">
        <button class="stepper-btn" onClick=${() => onChange(value - 5)}>-5</button>
        <button class="stepper-btn" onClick=${() => onChange(value - 2.5)}>-2.5</button>
        ${editing ? html`
          <input
            ref=${inputRef}
            class="stepper-input"
            type="number"
            inputmode="decimal"
            value=${editVal}
            onInput=${e => setEditVal(e.target.value)}
            onBlur=${commitEdit}
            onKeyDown=${e => e.key === 'Enter' && commitEdit()}
          />
        ` : html`
          <div class="stepper-value" onClick=${startEdit} style="cursor:pointer">${value < 0 ? value + ' (assist)' : value}<span class="stepper-unit"> lbs</span></div>
        `}
        <button class="stepper-btn" onClick=${() => onChange(value + 2.5)}>+2.5</button>
        <button class="stepper-btn" onClick=${() => onChange(value + 5)}>+5</button>
      </div>
      ${showPlates && plates.length > 0 && html`
        <div class="plate-calc">Each side: ${plates.map(p => p % 1 === 0 ? p : p.toFixed(2).replace(/0$/, '')).join(' + ')}</div>
      `}
      ${equipment === 'dumbbell' && value > 0 && (() => {
        const perHand = value / 2;
        const db = nearestDumbbell(perHand);
        const adjustedTotal = db * 2;
        const diff = adjustedTotal !== value;
        return html`
          <div class="plate-calc">
            ${db} lbs each dumbbell${diff ? html` <span style="color:var(--accent-amber)">(${adjustedTotal} lbs total)</span>` : ''}
          </div>
        `;
      })()}
    </div>
  `;
}

// --- Mini Stepper (for reps) ---
function RepStepper({ value, onChange }) {
  return html`
    <div class="mini-stepper">
      <button class="stepper-btn" onClick=${() => onChange(Math.max(0, value - 1))}>-</button>
      <div class="stepper-value">${value}</div>
      <button class="stepper-btn" onClick=${() => onChange(value + 1)}>+</button>
    </div>
  `;
}

// --- Rest Timer ---
function playBell() {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    // Bell: two sine tones with decay
    [880, 1174.66].forEach((freq, i) => {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = 'sine';
      osc.frequency.value = freq;
      gain.gain.setValueAtTime(0.3, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 1.5);
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start(ctx.currentTime + i * 0.15);
      osc.stop(ctx.currentTime + 1.5 + i * 0.15);
    });
  } catch (e) {}
}

function RestTimer({ restTimer, dispatch }) {
  const bellPlayed = useRef(false);

  useEffect(() => {
    if (!restTimer || !restTimer.active) return;
    bellPlayed.current = false;
    const id = setInterval(() => dispatch({ type: 'REST_TIMER_TICK' }), 1000);
    return () => clearInterval(id);
  }, [restTimer?.active]);

  if (!restTimer) return null;

  const mins = Math.floor(restTimer.remaining / 60);
  const secs = restTimer.remaining % 60;
  const pct = restTimer.seconds > 0 ? ((restTimer.seconds - restTimer.remaining) / restTimer.seconds) * 100 : 100;
  const done = restTimer.remaining <= 0;

  if (done && !bellPlayed.current) {
    bellPlayed.current = true;
    playBell();
  }

  return html`
    <div class="rest-timer-overlay">
      <div class="rest-timer-card ${done ? 'done' : ''}">
        <div class="rest-timer-label">${done ? 'Rest Complete!' : 'Rest Timer'}</div>
        <div class="rest-timer-display">${mins}:${secs.toString().padStart(2, '0')}</div>
        <div class="rest-timer-bar">
          <div class="rest-timer-fill" style="width:${pct}%"></div>
        </div>
        <div class="rest-timer-actions">
          <button class="btn btn-sm btn-ghost" onClick=${() => dispatch({ type: 'REST_TIMER_DISMISS' })}>Skip</button>
          ${[30, 60, 120, 180].map(s => html`
            <button class="btn btn-sm btn-ghost" onClick=${() => dispatch({ type: 'REST_TIMER_SET', seconds: s })}>
              ${s >= 60 ? `${s/60}m` : `${s}s`}
            </button>
          `)}
        </div>
      </div>
    </div>
  `;
}

// --- Nav Bar ---
function NavBar({ screen, dispatch }) {
  const items = [
    { id: 'start', label: 'Workout', icon: html`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6.5 6.5h11M4 12h16M6.5 17.5h11"/><circle cx="4" cy="6.5" r="2"/><circle cx="20" cy="6.5" r="2"/><circle cx="4" cy="17.5" r="2"/><circle cx="20" cy="17.5" r="2"/></svg>` },
    { id: 'muscles', label: 'Muscles', icon: html`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a5 5 0 015 5v3a5 5 0 01-10 0V7a5 5 0 015-5z"/><path d="M8 14v2a4 4 0 008 0v-2"/><path d="M12 18v4"/></svg>` },
    { id: 'history', label: 'History', icon: html`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>` },
    { id: 'settings', label: 'Settings', icon: html`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83"/></svg>` },
  ];

  return html`
    <nav class="nav">
      ${items.map(item => html`
        <button
          class="nav-item ${screen === item.id || (screen === 'workout' && item.id === 'start') ? 'active' : ''}"
          onClick=${() => dispatch({ type: 'NAVIGATE', screen: item.id })}
        >
          ${item.icon}
          ${item.label}
        </button>
      `)}
    </nav>
  `;
}

// --- Start Session Screen ---
function StartScreen({ state, dispatch }) {
  const dayOrder = ['squat', 'bench_press', 'deadlift', 'overhead_press'];
  const lastIdx = state.lastProgramId ? dayOrder.indexOf(state.lastProgramId) : -1;
  const nextDay = dayOrder[(lastIdx + 1) % 4];
  const [selectedDay, setSelectedDay] = useState(nextDay);
  const [startTime, setStartTime] = useState(nowTimeStr());
  const [locker, setLocker] = useState(state.settings.lastLockerNumber);
  const [feeling, setFeeling] = useState(null);
  // Cardio warmup
  const [showCardio, setShowCardio] = useState(false);
  const [cardioType, setCardioType] = useState('Treadmill');
  const [cardioTime, setCardioTime] = useState('');
  const [cardioDist, setCardioDist] = useState('');

  const hasTMs = MAIN_LIFTS.every(l => state.trainingMaxes[l] > 0);
  const week = WEEK_SCHEMES[state.cycleWeek];
  const tm = state.trainingMaxes[selectedDay] || 0;

  const plannedMuscles = getPlannedMuscles(selectedDay);

  const cardioPace = cardioTime && cardioDist && parseFloat(cardioDist) > 0
    ? (parseFloat(cardioTime) / parseFloat(cardioDist)).toFixed(1) + ' min/mi'
    : null;

  const cardioData = showCardio && cardioTime ? {
    type: cardioType,
    time: parseFloat(cardioTime) || 0,
    distance: parseFloat(cardioDist) || 0,
    pace: cardioPace,
  } : null;

  return html`
    <div class="screen fade-in">
      <div class="screen-title">IronLog</div>

      ${!hasTMs && html`
        <div class="card" style="border-color:var(--accent-amber);margin-bottom:16px">
          <div style="font-size:14px;color:var(--accent-amber);font-weight:600;margin-bottom:4px">Set Training Maxes</div>
          <div style="font-size:13px;color:var(--text-secondary)">Go to Settings to enter your Training Maxes before starting a 5/3/1 workout.</div>
        </div>
      `}

      <div class="card" style="margin-bottom:12px">
        <div style="font-size:13px;color:var(--text-secondary);margin-bottom:4px">
          Cycle ${state.cycleNumber} · ${week?.name || 'Week ' + state.cycleWeek}
        </div>
      </div>

      <div class="input-group">
        <label class="input-label">How are you feeling?</label>
        <div class="feeling-row">
          ${['Great', 'OK', 'Off'].map(f => html`
            <button
              class="feeling-btn ${feeling === f ? 'selected' : ''}"
              onClick=${() => setFeeling(f)}
            >${f}</button>
          `)}
        </div>
      </div>

      <div style="display:flex;gap:12px">
        <div class="input-group" style="flex:1">
          <label class="input-label">Start Time</label>
          <input type="time" class="input-field" value=${startTime} onInput=${e => setStartTime(e.target.value)} />
        </div>
        <div class="input-group" style="flex:1">
          <label class="input-label">Locker #</label>
          <input type="number" class="input-field" value=${locker} onInput=${e => setLocker(e.target.value)} placeholder="—" inputmode="numeric" />
        </div>
      </div>

      <!-- Cardio Warmup -->
      <div class="input-group">
        <button class="btn btn-sm btn-ghost" style="margin-bottom:8px" onClick=${() => setShowCardio(!showCardio)}>
          ${showCardio ? '- Hide Cardio Warmup' : '+ Cardio Warmup'}
        </button>
        ${showCardio && html`
          <div class="card fade-in">
            <div style="display:flex;gap:8px;margin-bottom:8px">
              ${['Treadmill', 'Bike', 'Elliptical', 'Row'].map(t => html`
                <button class="feeling-btn ${cardioType === t ? 'selected' : ''}" style="font-size:12px;padding:6px" onClick=${() => setCardioType(t)}>${t}</button>
              `)}
            </div>
            <div style="display:flex;gap:8px">
              <div style="flex:1">
                <label class="input-label">Time (min)</label>
                <input type="number" class="input-field" value=${cardioTime} onInput=${e => setCardioTime(e.target.value)} inputmode="decimal" placeholder="10" />
              </div>
              <div style="flex:1">
                <label class="input-label">Distance (mi)</label>
                <input type="number" class="input-field" value=${cardioDist} onInput=${e => setCardioDist(e.target.value)} inputmode="decimal" placeholder="1.0" />
              </div>
            </div>
            ${cardioPace && html`<div style="font-size:12px;color:var(--accent-blue);margin-top:6px">Pace: ${cardioPace}</div>`}
          </div>
        `}
      </div>

      <!-- 5/3/1 Day Selection -->
      <div class="input-group">
        <label class="input-label">Workout Day</label>
        ${dayOrder.map(dayId => {
          const prog = PROGRAMS[dayId];
          const dayTm = state.trainingMaxes[dayId] || 0;
          const bbbLift = BBB_SWAP[dayId];
          const isNext = dayId === nextDay;
          return html`
            <div
              class="program-option ${selectedDay === dayId ? 'selected' : ''}"
              onClick=${() => setSelectedDay(dayId)}
            >
              <div class="name">${prog.name}${isNext ? ' (Next)' : ''}</div>
              <div class="exercises">
                <div>5/3/1: ${EXERCISES[dayId].name}${dayTm ? ` (TM: ${dayTm})` : ''}</div>
                <div>BBB: ${EXERCISES[bbbLift].name} 5×10</div>
                <div style="color:var(--text-muted)">${prog.accessories.map(a => EXERCISES[a.exerciseId].name).join(', ')}</div>
              </div>
            </div>
          `;
        })}
      </div>

      <${MuscleMap} planned=${plannedMuscles} completed=${[]} partial=${[]} mini=${true} />

      <button
        class="btn btn-success"
        style="margin-top:8px;font-size:18px;padding:16px"
        disabled=${!hasTMs}
        onClick=${() => dispatch({
          type: 'START_SESSION',
          startTime,
          lockerNumber: locker,
          programId: selectedDay,
          cardio: cardioData,
        })}
      >
        Start Workout
      </button>
    </div>
  `;
}

// Helper: get muscles for a 5/3/1 day
function getPlannedMuscles(dayId) {
  const prog = PROGRAMS[dayId];
  if (!prog) return [];
  const muscles = new Set();
  const allExIds = [prog.mainLift, prog.bbbLift, ...prog.accessories.map(a => a.exerciseId)];
  allExIds.forEach(exId => {
    const ex = EXERCISES[exId];
    if (ex) {
      ex.primaryMuscles.forEach(m => muscles.add(m));
      ex.secondaryMuscles.forEach(m => muscles.add(m));
    }
  });
  return [...muscles];
}

// --- Active Workout Screen ---
function WorkoutScreen({ state, dispatch, syncToCoach, syncing }) {
  const session = state.activeSession;
  if (!session) return null;

  const planned = getPlannedMuscles(session.programId);
  const completed = getCompletedMuscles(session.exercises);
  const partial = getPartialMuscles(session.exercises);
  const [showEndConfirm, setShowEndConfirm] = useState(false);
  const [showAddExercise, setShowAddExercise] = useState(false);
  const week = WEEK_SCHEMES[session.cycleWeek];
  const usedExerciseIds = session.exercises.map(e => e.exerciseId);

  return html`
    <div class="screen fade-in">
      <div class="session-header">
        <div>
          <div class="info">${PROGRAMS[session.programId]?.name || 'Workout'}</div>
          <div class="meta">
            ${week?.name || ''} · ${formatTime(session.startTime)}
            ${session.lockerNumber ? ` · Locker ${session.lockerNumber}` : ''}
          </div>
        </div>
        <${ElapsedTimer} startTime=${session.startTime} />
      </div>

      ${session.cardio && html`
        <div class="card" style="margin-bottom:12px">
          <div style="font-size:12px;color:var(--text-secondary);text-transform:uppercase;font-weight:600;margin-bottom:4px">Cardio Warmup</div>
          <div style="font-size:14px">${session.cardio.type}: ${session.cardio.time}min${session.cardio.distance ? ` · ${session.cardio.distance}mi` : ''}${session.cardio.pace ? ` · ${session.cardio.pace}` : ''}</div>
        </div>
      `}

      <${MuscleMap} planned=${planned} completed=${completed} partial=${partial} mini=${true} />

      ${session.exercises.map((se, ei) => html`
        <${ExerciseCard}
          key=${se.exerciseId + '_' + ei}
          exerciseLog=${se}
          exerciseIndex=${ei}
          expanded=${state.expandedExercise === ei}
          exerciseHistory=${state.exerciseHistory}
          dispatch=${dispatch}
        />
      `)}

      <${RestTimer} restTimer=${state.restTimer} dispatch=${dispatch} />

      <!-- Add Exercise -->
      <div style="margin-top:12px">
        <button class="btn btn-ghost" style="width:100%" onClick=${() => setShowAddExercise(!showAddExercise)}>
          ${showAddExercise ? '- Cancel' : '+ Add Exercise'}
        </button>
        ${showAddExercise && html`
          <div class="card fade-in" style="margin-top:8px;max-height:300px;overflow-y:auto">
            ${Object.values(EXERCISES)
              .filter(ex => !usedExerciseIds.includes(ex.id))
              .map(ex => html`
                <div class="add-exercise-row" onClick=${() => {
                  dispatch({ type: 'ADD_EXERCISE', exerciseId: ex.id, sets: ex.defaultSets, reps: ex.defaultReps });
                  setShowAddExercise(false);
                }}>
                  <div>
                    <div style="font-weight:600;font-size:14px">${ex.name}</div>
                    <div style="font-size:12px;color:var(--text-muted)">${ex.defaultSets}×${ex.defaultReps} · ${ex.primaryMuscles.map(m => MUSCLE_GROUPS[m]?.label).join(', ')}</div>
                  </div>
                  <span style="color:var(--accent-blue);font-size:20px">+</span>
                </div>
              `)
            }
          </div>
        `}
      </div>

      <div style="margin-top:16px">
        ${showEndConfirm ? html`
          <div class="card">
            <p style="margin-bottom:12px;font-size:14px;color:var(--text-secondary)">End this workout and advance to next week?</p>
            <div style="display:flex;gap:8px">
              <button class="btn btn-danger" style="flex:1" onClick=${() => { dispatch({ type: 'END_SESSION' }); dispatch({ type: 'ADVANCE_CYCLE' }); }}>End & Advance</button>
              <button class="btn btn-ghost" style="flex:1" onClick=${() => setShowEndConfirm(false)}>Cancel</button>
            </div>
          </div>
        ` : html`
          <div style="display:flex;gap:8px">
            <button class="btn btn-ghost" style="flex:1" onClick=${syncToCoach} disabled=${syncing}>
              ${syncing ? 'Syncing...' : 'Sync with Coach'}
            </button>
            <button class="btn btn-ghost" style="flex:1" onClick=${() => setShowEndConfirm(true)}>End Workout</button>
          </div>
        `}
      </div>
    </div>
  `;
}

function ElapsedTimer({ startTime }) {
  const [elapsed, setElapsed] = useState('');

  useEffect(() => {
    function update() {
      const [h, m] = startTime.split(':').map(Number);
      const start = new Date();
      start.setHours(h, m, 0, 0);
      const diff = Math.floor((Date.now() - start.getTime()) / 1000);
      if (diff < 0) { setElapsed('0:00'); return; }
      const mins = Math.floor(diff / 60);
      const secs = diff % 60;
      setElapsed(`${mins}:${secs.toString().padStart(2, '0')}`);
    }
    update();
    const id = setInterval(update, 1000);
    return () => clearInterval(id);
  }, [startTime]);

  return html`<div class="timer">${elapsed}</div>`;
}

function ExerciseCard({ exerciseLog, exerciseIndex, expanded, exerciseHistory, dispatch }) {
  const ex = EXERCISES[exerciseLog.exerciseId];
  const completedSets = exerciseLog.sets.filter(s => s.completed).length;
  const totalSets = exerciseLog.sets.length;
  const fixedEquipment = ex?.equipmentType; // cable, machine, bodyweight = no barbell/dumbbell toggle
  const isFreeWeight = !fixedEquipment || fixedEquipment === 'barbell' || fixedEquipment === 'dumbbell';
  const equipment = isFreeWeight ? (exerciseLog.equipment || 'barbell') : fixedEquipment;
  const showPlates = equipment === 'barbell' && ex && (ex.category === 'compound');

  let badgeClass = 'pending';
  let badgeText = `0/${totalSets}`;
  if (completedSets === totalSets) { badgeClass = 'complete'; badgeText = 'Done'; }
  else if (completedSets > 0) { badgeClass = 'partial'; badgeText = `${completedSets}/${totalSets}`; }

  const categoryColor = exerciseLog.category === 'main' ? 'var(--accent-blue)'
    : exerciseLog.category === 'supplemental' ? 'var(--accent-purple)'
    : 'var(--text-muted)';

  return html`
    <div class="exercise-card">
      <div
        class="exercise-header"
        onClick=${() => dispatch({ type: 'SET_EXPANDED', index: expanded ? -1 : exerciseIndex })}
      >
        <div>
          <div class="exercise-name">${ex?.name || exerciseLog.exerciseId}</div>
          <div class="exercise-target">
            <span style="color:${categoryColor};font-weight:600">${exerciseLog.label || ''}</span>
            ${exerciseLog.label ? ' · ' : ''}${totalSets} sets
          </div>
        </div>
        <span class="exercise-badge ${badgeClass}">${badgeText}</span>
      </div>

      ${expanded && html`
        <div class="exercise-body fade-in">
          <div class="equipment-toggle">
            ${isFreeWeight ? html`
              <button class="btn btn-sm ${equipment === 'barbell' ? 'btn-primary' : 'btn-ghost'}"
                onClick=${() => dispatch({ type: 'SET_EQUIPMENT', exerciseIndex, equipment: 'barbell' })}>Barbell</button>
              <button class="btn btn-sm ${equipment === 'dumbbell' ? 'btn-primary' : 'btn-ghost'}"
                onClick=${() => dispatch({ type: 'SET_EQUIPMENT', exerciseIndex, equipment: 'dumbbell' })}>Dumbbell</button>
            ` : html`
              <span class="btn btn-sm btn-ghost" style="cursor:default;opacity:0.6">${fixedEquipment === 'cable' ? 'Cable' : fixedEquipment === 'machine' ? 'Machine' : 'Bodyweight'}</span>
            `}
            <button class="btn btn-sm" style="margin-left:auto;color:var(--accent-red);border-color:var(--accent-red)"
              onClick=${() => { if (confirm('Remove ' + (ex?.name || 'exercise') + '?')) dispatch({ type: 'REMOVE_EXERCISE', exerciseIndex }); }}>Remove</button>
          </div>
          ${exerciseLog.sets.map((set, si) => html`
            <div class="set-row">
              <div class="set-row-header">
                <div class="set-num">
                  Set ${si + 1}
                  ${set.pct ? html` <span style="color:var(--text-muted);font-weight:400">@ ${Math.round(set.pct * 100)}%</span>` : ''}
                </div>
                <div style="font-size:12px;color:var(--text-muted)">${set.targetReps}+ reps</div>
              </div>
              <div class="set-weight-row">
                <${WeightStepper}
                  value=${set.weight}
                  onChange=${v => dispatch({ type: 'UPDATE_SET', exerciseIndex, setIndex: si, field: 'weight', value: v })}
                  showPlates=${showPlates && set.weight >= BAR_WEIGHT}
                  equipment=${equipment}
                />
              </div>
              <div class="set-bottom-row">
                <div style="display:flex;align-items:center">
                  <span class="reps-label">REPS</span>
                  <${RepStepper}
                    value=${set.reps}
                    onChange=${v => dispatch({ type: 'UPDATE_SET', exerciseIndex, setIndex: si, field: 'reps', value: v })}
                  />
                </div>
                <button
                  class="set-check ${set.completed ? (set.reps >= set.targetReps ? 'done' : 'failed') : ''}"
                  onClick=${() => dispatch({ type: 'TOGGLE_SET_COMPLETE', exerciseIndex, setIndex: si })}
                >
                  ${set.completed ? (set.reps >= set.targetReps ? '\u2713' : '\u2717') : ''}
                </button>
              </div>
              <input
                class="set-notes"
                type="text"
                placeholder="Notes..."
                value=${set.notes || ''}
                onInput=${e => dispatch({ type: 'UPDATE_SET', exerciseIndex, setIndex: si, field: 'notes', value: e.target.value })}
              />
            </div>
          `)}
        </div>
      `}
    </div>
  `;
}

// --- History Screen ---
function HistoryScreen({ state, dispatch }) {
  if (state.detailView) {
    return html`<${ExerciseDetailView} state=${state} dispatch=${dispatch} />`;
  }

  const sorted = [...state.sessions].reverse();

  return html`
    <div class="screen fade-in">
      <div class="screen-title">History</div>

      ${sorted.length === 0 && html`
        <div class="empty-state">
          <div class="icon">📋</div>
          <div>No workouts yet. Start your first one!</div>
        </div>
      `}

      ${sorted.map(session => html`
        <div class="history-card" onClick=${() => dispatch({ type: 'VIEW_DETAIL', detail: { type: 'session', session } })}>
          <div class="history-date">${formatDate(session.date)} · ${PROGRAMS[session.programId]?.name || 'Custom'}</div>
          <div class="history-meta">
            ${formatTime(session.startTime)}${session.endTime ? ` - ${formatTime(session.endTime)}` : ''}
            ${session.duration ? ` · ${Math.floor(session.duration / 60)}min` : ''}
            ${session.lockerNumber ? ` · Locker ${session.lockerNumber}` : ''}
            ${session.cycleWeek ? ` · W${session.cycleWeek}` : ''}
          </div>
          <div class="history-exercises">
            ${session.exercises.map(se => {
              const ex = EXERCISES[se.exerciseId];
              const allDone = se.sets.every(s => s.completed && s.reps >= (s.targetReps || 0));
              const maxWeight = Math.max(...se.sets.map(s => s.weight));
              return html`
                <span class="history-ex-tag ${allDone ? 'success' : 'fail'}">
                  ${ex?.name || se.exerciseId} ${maxWeight}
                </span>
              `;
            })}
          </div>
        </div>
      `)}

      ${Object.keys(state.exerciseHistory).length > 0 && html`
        <div style="margin-top:20px">
          <div class="input-label" style="margin-bottom:12px">Exercise Progress</div>
          ${Object.entries(state.exerciseHistory).map(([exId, data]) => {
            const ex = EXERCISES[exId];
            const pts = data.history.slice(0, 10).reverse();
            const minW = Math.min(...pts.map(p => p.weight));
            const maxW = Math.max(...pts.map(p => p.weight));
            const range = maxW - minW || 1;
            const sparkW = 80, sparkH = 24;
            const sparkPath = pts.length > 1
              ? pts.map((p, i) => {
                  const x = (i / (pts.length - 1)) * sparkW;
                  const y = sparkH - ((p.weight - minW) / range) * (sparkH - 4) - 2;
                  return (i === 0 ? 'M' : 'L') + x.toFixed(1) + ',' + y.toFixed(1);
                }).join(' ')
              : null;
            const trendColor = pts.length > 1
              ? (pts[pts.length-1].weight > pts[0].weight ? 'var(--accent-green)' : pts[pts.length-1].weight < pts[0].weight ? 'var(--accent-red)' : 'var(--text-secondary)')
              : 'var(--text-secondary)';
            return html`
              <div
                class="history-card"
                onClick=${() => dispatch({ type: 'VIEW_DETAIL', detail: { type: 'exercise', exerciseId: exId } })}
              >
                <div class="sparkline-row">
                  <div>
                    <div class="history-date">${ex?.name || exId}</div>
                    <div class="history-meta">
                      Last: ${data.lastWeight} lbs · ${data.history.length} sessions
                      ${data.consecutiveFailures > 0 ? ` · ${data.consecutiveFailures} fail(s)` : ''}
                    </div>
                  </div>
                  ${sparkPath && html`
                    <svg width="${sparkW}" height="${sparkH}" viewBox="0 0 ${sparkW} ${sparkH}">
                      <polyline points=${sparkPath.replace(/[ML]/g, '')} fill="none" stroke=${trendColor} stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                  `}
                </div>
              </div>
            `;
          })}
        </div>
      `}
    </div>
  `;
}

function ExerciseDetailView({ state, dispatch }) {
  const detail = state.detailView;

  if (detail.type === 'session') {
    const session = detail.session;
    const planned = getPlannedMuscles(session.programId);
    const completed = getCompletedMuscles(session.exercises);
    const [copied, setCopied] = useState(false);

    const generateSummary = () => {
      let text = `🏋️ ${formatDate(session.date)} — ${PROGRAMS[session.programId]?.name || 'Custom'}\n`;
      text += `${formatTime(session.startTime)}${session.endTime ? ` - ${formatTime(session.endTime)}` : ''}`;
      if (session.duration) text += ` (${Math.floor(session.duration / 60)}min)`;
      text += '\n';
      if (session.cardio) {
        text += `\nCardio: ${session.cardio.type} ${session.cardio.time}min`;
        if (session.cardio.distance) text += ` ${session.cardio.distance}mi`;
        if (session.cardio.pace) text += ` @ ${session.cardio.pace}`;
        text += '\n';
      }
      session.exercises.forEach(se => {
        const ex = EXERCISES[se.exerciseId];
        text += `\n${ex?.name || se.exerciseId}${se.equipment === 'dumbbell' ? ' (DB)' : ''}:`;
        se.sets.forEach((s, i) => {
          const status = s.completed ? (s.reps >= (s.targetReps || 0) ? '✓' : '✗') : '—';
          text += `\n  Set ${i+1}: ${s.weight} lbs × ${s.reps} ${status}`;
          if (s.notes) text += ` — ${s.notes}`;
        });
        text += '\n';
      });
      return text;
    };

    const copyToClipboard = () => {
      navigator.clipboard.writeText(generateSummary()).then(() => {
        setCopied(true);
        setTimeout(() => setCopied(false), 2000);
      });
    };

    return html`
      <div class="screen fade-in">
        <button class="back-btn" onClick=${() => dispatch({ type: 'BACK_FROM_DETAIL' })}>← Back</button>
        <div class="screen-title">${formatDate(session.date)} · ${PROGRAMS[session.programId]?.name || 'Custom'}</div>
        <div style="font-size:13px;color:var(--text-secondary);margin-bottom:16px">
          ${formatTime(session.startTime)}${session.endTime ? ` - ${formatTime(session.endTime)}` : ''}
          ${session.duration ? ` · ${Math.floor(session.duration / 60)}min` : ''}
          ${session.lockerNumber ? ` · Locker ${session.lockerNumber}` : ''}
        </div>
        <button class="btn btn-ghost" style="margin-bottom:12px;width:100%" onClick=${copyToClipboard}>
          ${copied ? 'Copied!' : 'Copy Summary for Telegram'}
        </button>
        <${MuscleMap} planned=${planned} completed=${completed} partial=${[]} />
        ${session.exercises.map(se => {
          const ex = EXERCISES[se.exerciseId];
          return html`
            <div class="card">
              <div class="card-title">${ex?.name || se.exerciseId}</div>
              ${se.sets.map((s, i) => html`
                <div class="detail-row">
                  <span>Set ${i + 1}</span>
                  <span>${s.weight} lbs × ${s.reps} ${s.completed ? (s.reps >= (s.targetReps || 0) ? '✓' : '✗') : '—'}</span>
                </div>
                ${s.notes ? html`<div style="font-size:12px;color:var(--text-muted);padding:2px 0 4px 0;font-style:italic">${s.notes}</div>` : ''}
              `)}
            </div>
          `;
        })}
      </div>
    `;
  }

  if (detail.type === 'exercise') {
    const exId = detail.exerciseId;
    const ex = EXERCISES[exId];
    const data = state.exerciseHistory[exId];
    if (!data) return html`<div class="screen">No data</div>`;

    const [rangeFilter, setRangeFilter] = useState('all');

    // Filter history by range
    const allHistory = data.history;
    const now = new Date();
    const filtered = rangeFilter === 'all' ? allHistory : allHistory.filter(h => {
      const days = (now - new Date(h.date)) / (1000 * 60 * 60 * 24);
      return rangeFilter === '30' ? days <= 30 : rangeFilter === '90' ? days <= 90 : days <= 180;
    });

    // Stats
    const allTimeMax = allHistory.length > 0 ? Math.max(...allHistory.map(h => h.weight)) : 0;
    const allTimeMaxDate = allHistory.find(h => h.weight === allTimeMax)?.date;
    const last5 = allHistory.slice(0, 5);
    const last5Avg = last5.length > 0 ? Math.round(last5.reduce((s, h) => s + h.weight, 0) / last5.length) : 0;
    const successes = filtered.filter(h => h.allCompleted).length;
    const successRate = filtered.length > 0 ? Math.round(successes / filtered.length * 100) : 0;

    // Trend: compare first half avg to second half avg of filtered
    const trendData = filtered.slice().reverse();
    let trendVal = 0, trendLabel = 'Flat';
    if (trendData.length >= 2) {
      const first = trendData[0].weight;
      const last = trendData[trendData.length - 1].weight;
      trendVal = last - first;
      trendLabel = trendVal > 0 ? `+${trendVal} lbs` : trendVal < 0 ? `${trendVal} lbs` : 'Flat';
    }
    const trendClass = trendVal > 0 ? 'trend-up' : trendVal < 0 ? 'trend-down' : 'trend-flat';

    // Chart data
    const history = filtered.slice(0, 30).reverse();
    const maxWeight = Math.max(...history.map(h => h.weight), 1);
    const barWidth = Math.max(12, Math.floor(280 / Math.max(history.length, 1)) - 4);

    return html`
      <div class="screen fade-in">
        <button class="back-btn" onClick=${() => dispatch({ type: 'BACK_FROM_DETAIL' })}>← Back</button>
        <div class="screen-title">${ex?.name || exId}</div>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">All-Time PR</div>
            <div class="stat-value">${allTimeMax}</div>
            <div class="stat-sub">${allTimeMaxDate ? formatDate(allTimeMaxDate) : '—'}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Trend</div>
            <div class="stat-value ${trendClass}">${trendLabel}</div>
            <div class="stat-sub">${filtered.length} session${filtered.length !== 1 ? 's' : ''} in range</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Last 5 Avg</div>
            <div class="stat-value">${last5Avg}</div>
            <div class="stat-sub">lbs</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Success Rate</div>
            <div class="stat-value" style="color:${successRate >= 80 ? 'var(--accent-green)' : successRate >= 50 ? 'var(--accent-amber)' : 'var(--accent-red)'}">${successRate}%</div>
            <div class="stat-sub">${successes}/${filtered.length} completed</div>
          </div>
        </div>

        <div class="range-filters">
          ${['30', '90', '180', 'all'].map(r => html`
            <button class="range-btn ${rangeFilter === r ? 'active' : ''}" onClick=${() => setRangeFilter(r)}>
              ${r === 'all' ? 'All' : r + 'd'}
            </button>
          `)}
        </div>

        <div class="card">
          <div class="card-title">Progress</div>
          <div class="card-subtitle">Current: ${data.lastWeight} lbs · ${filtered.length} sessions</div>
          ${history.length > 0 ? html`
            <div class="chart-container">
              <svg viewBox="0 0 ${history.length * (barWidth + 4) + 20} 150">
                ${history.map((h, i) => {
                  const barHeight = (h.weight / maxWeight) * 100;
                  const x = 10 + i * (barWidth + 4);
                  const y = 120 - barHeight;
                  return html`
                    <rect x=${x} y=${y} width=${barWidth} height=${barHeight} class="chart-bar ${h.allCompleted ? '' : 'fail'}" />
                    <text x=${x + barWidth/2} y="140" class="chart-label">${h.date.slice(5)}</text>
                    <text x=${x + barWidth/2} y=${y - 4} class="chart-value">${h.weight}</text>
                  `;
                })}
              </svg>
            </div>
          ` : html`<div style="color:var(--text-muted);font-size:13px;padding:12px 0">No sessions in this range</div>`}
        </div>

        <div class="card">
          <div class="card-title">History</div>
          ${filtered.slice(0, 30).map(h => html`
            <div class="detail-row">
              <span>${formatDate(h.date)}</span>
              <span style="color:${h.allCompleted ? 'var(--accent-green)' : 'var(--accent-red)'}">
                ${h.weight} lbs ${h.allCompleted ? '✓' : '✗'}
              </span>
            </div>
          `)}
        </div>
      </div>
    `;
  }

  return null;
}

// --- Muscle Map Full Screen ---
function MusclesScreen({ state }) {
  const lastSession = state.sessions[state.sessions.length - 1];
  const dayOrder = ['squat', 'bench_press', 'deadlift', 'overhead_press'];
  const lastIdx = state.lastProgramId ? dayOrder.indexOf(state.lastProgramId) : -1;
  const nextDay = dayOrder[(lastIdx + 1) % 4];
  const planned = getPlannedMuscles(nextDay);

  const lastCompleted = lastSession ? getCompletedMuscles(lastSession.exercises) : [];

  return html`
    <div class="screen fade-in">
      <div class="screen-title">Muscle Map</div>

      <div class="input-label" style="margin-bottom:8px">Next Workout: ${PROGRAMS[nextDay]?.name}</div>
      <${MuscleMap} planned=${planned} completed=${[]} partial=${[]} />

      ${lastSession && html`
        <div style="margin-top:16px">
          <div class="input-label" style="margin-bottom:8px">Last Workout (${formatDate(lastSession.date)})</div>
          <${MuscleMap} planned=${[]} completed=${lastCompleted} partial=${[]} />
        </div>
      `}

      <div class="card" style="margin-top:16px">
        <div class="card-title">Muscle Groups</div>
        ${Object.entries(MUSCLE_GROUPS).map(([id, mg]) => {
          const exercises = Object.values(EXERCISES).filter(
            e => e.primaryMuscles.includes(id)
          );
          return html`
            <div class="detail-row">
              <span>${mg.label}</span>
              <span style="font-size:12px;color:var(--text-secondary)">
                ${exercises.map(e => e.name).join(', ')}
              </span>
            </div>
          `;
        })}
      </div>
    </div>
  `;
}

// --- Settings Screen ---
function SettingsScreen({ state, dispatch, syncToCoach, syncing }) {
  const [tmInputs, setTmInputs] = useState(() => {
    const inputs = {};
    MAIN_LIFTS.forEach(l => { inputs[l] = String(state.trainingMaxes[l] || ''); });
    return inputs;
  });
  const [use1RM, setUse1RM] = useState(false);
  const [exportMsg, setExportMsg] = useState('');

  const saveTMs = () => {
    MAIN_LIFTS.forEach(lift => {
      let val = parseFloat(tmInputs[lift]);
      if (isNaN(val) || val <= 0) return;
      if (use1RM) val = roundTo5(val * 0.9); // Convert 1RM → TM (90%)
      dispatch({ type: 'SET_TRAINING_MAX', exerciseId: lift, weight: val });
    });
  };

  const exportData = () => {
    const data = JSON.stringify({
      sessions: state.sessions,
      exerciseHistory: state.exerciseHistory,
      trainingMaxes: state.trainingMaxes,
      cycleWeek: state.cycleWeek,
      cycleNumber: state.cycleNumber,
      exportDate: new Date().toISOString(),
    }, null, 2);
    const blob = new Blob([data], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'ironlog_export_' + todayStr() + '.json';
    a.click();
    URL.revokeObjectURL(url);
    setExportMsg('Exported!');
    setTimeout(() => setExportMsg(''), 2000);
  };

  return html`
    <div class="screen fade-in">
      <div class="screen-title">Settings</div>

      <!-- Training Maxes -->
      <div class="card">
        <div class="card-title">Training Maxes</div>
        <div class="card-subtitle" style="margin-bottom:12px">
          ${use1RM ? 'Enter your 1RM (will auto-calculate TM at 90%)' : 'Enter your Training Max directly'}
        </div>

        <div style="margin-bottom:12px">
          <button
            class="btn btn-sm btn-ghost"
            onClick=${() => setUse1RM(!use1RM)}
          >
            ${use1RM ? 'Switch to TM entry' : 'Switch to 1RM entry (auto 90%)'}
          </button>
        </div>

        ${MAIN_LIFTS.map(lift => {
          const ex = EXERCISES[lift];
          const currentTM = state.trainingMaxes[lift];
          return html`
            <div class="input-group">
              <label class="input-label">${ex.name}${currentTM ? ` (current TM: ${currentTM})` : ''}</label>
              <input
                type="number"
                class="input-field"
                value=${tmInputs[lift]}
                onInput=${e => setTmInputs({ ...tmInputs, [lift]: e.target.value })}
                placeholder=${use1RM ? '1RM in lbs' : 'TM in lbs'}
                inputmode="numeric"
              />
            </div>
          `;
        })}

        <button class="btn btn-primary" onClick=${saveTMs}>Save Training Maxes</button>
      </div>

      <!-- Cycle Management -->
      <div class="card">
        <div class="card-title">Cycle</div>
        <div style="font-size:14px;margin-bottom:8px">
          Cycle ${state.cycleNumber} · ${WEEK_SCHEMES[state.cycleWeek]?.name || 'Week ' + state.cycleWeek}
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          ${[1, 2, 3, 4].map(w => html`
            <button
              class="btn btn-sm ${state.cycleWeek === w ? 'btn-primary' : 'btn-ghost'}"
              onClick=${() => dispatch({ type: 'SET_CYCLE_WEEK', week: w })}
            >
              ${WEEK_SCHEMES[w].name}
            </button>
          `)}
        </div>
      </div>

      <!-- Data Export -->
      <div class="card">
        <div class="card-title">Data</div>
        <div style="font-size:13px;color:var(--text-secondary);margin-bottom:8px">
          ${state.sessions.length} workouts logged
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn btn-ghost" style="flex:1" onClick=${exportData}>
            ${exportMsg || 'Export JSON'}
          </button>
          <button class="btn btn-primary" style="flex:1" onClick=${syncToCoach} disabled=${syncing}>
            ${syncing ? 'Syncing...' : 'Sync with Coach'}
          </button>
        </div>
      </div>

      <!-- Reset App -->
      <div class="card">
        <div class="card-title" style="color:var(--accent-red)">Reset</div>
        <div style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">
          Erase all data and start fresh. This cannot be undone.
        </div>
        <button
          class="btn"
          style="background:var(--accent-red);color:#fff"
          onClick=${() => {
            if (confirm('Are you sure? This will delete ALL your workout data, training maxes, and history.')) {
              dispatch({ type: 'RESET_APP' });
            }
          }}
        >
          Reset App
        </button>
      </div>
    </div>
  `;
}

// ═══════════════════════════════════════════════════════════════
// SECTION 8: APP ROOT
// ═══════════════════════════════════════════════════════════════

const API_BASE = window.location.origin;
let lastCommandTs = null;

function App() {
  const [state, dispatch] = useReducer(appReducer, null, initState);
  const [coachMsg, setCoachMsg] = useState(null);
  const [syncing, setSyncing] = useState(false);
  const stateRef = useRef(state);
  stateRef.current = state;

  useEffect(() => {
    saveState(state);
  }, [state]);

  // Poll for commands from coach (me)
  useEffect(() => {
    async function pollCommands() {
      try {
        const resp = await fetch(API_BASE + '/api/commands?t=' + Date.now());
        const data = await resp.json();
        if (data.updatedAt && data.updatedAt !== lastCommandTs) {
          lastCommandTs = data.updatedAt;
          if (data.actions && data.actions.length > 0) {
            data.actions.forEach(action => dispatch(action));
          }
          if (data.message) {
            setCoachMsg(data.message);
            setTimeout(() => setCoachMsg(null), 8000);
          }
        }
      } catch (e) {}
    }
    pollCommands();
    const id = setInterval(pollCommands, 30000);
    return () => clearInterval(id);
  }, []);

  // Sync state to coach
  const sendState = async (silent = false) => {
    const url = API_BASE + '/api/state' + (silent ? '?silent=1' : '');
    await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        activeSession: stateRef.current.activeSession,
        trainingMaxes: stateRef.current.trainingMaxes,
        sessions: stateRef.current.sessions,
        exerciseHistory: stateRef.current.exerciseHistory,
        cycleWeek: stateRef.current.cycleWeek,
        cycleNumber: stateRef.current.cycleNumber,
      }),
    });
  };

  const syncToCoach = async () => {
    setSyncing(true);
    try {
      await sendState(false);
      setCoachMsg('State synced to coach!');
      setTimeout(() => setCoachMsg(null), 3000);
    } catch (e) {
      setCoachMsg('Sync failed — try again');
      setTimeout(() => setCoachMsg(null), 3000);
    }
    setSyncing(false);
  };

  // Auto-sync: silently save state when sets are completed (debounced)
  const autoSyncTimer = useRef(null);
  useEffect(() => {
    if (!state.activeSession) return;
    const completedSets = state.activeSession.exercises
      .reduce((n, ex) => n + ex.sets.filter(s => s.completed).length, 0);
    if (completedSets === 0) return;
    clearTimeout(autoSyncTimer.current);
    autoSyncTimer.current = setTimeout(() => {
      sendState(true).catch(() => {});
    }, 5000);
  }, [state.activeSession]);

  const screenMap = {
    start: html`<${StartScreen} state=${state} dispatch=${dispatch} />`,
    workout: html`<${WorkoutScreen} state=${state} dispatch=${dispatch} syncToCoach=${syncToCoach} syncing=${syncing} />`,
    history: html`<${HistoryScreen} state=${state} dispatch=${dispatch} />`,
    muscles: html`<${MusclesScreen} state=${state} />`,
    settings: html`<${SettingsScreen} state=${state} dispatch=${dispatch} syncToCoach=${syncToCoach} syncing=${syncing} />`,
  };

  return html`
    ${coachMsg && html`<div class="coach-msg">${coachMsg}</div>`}
    ${screenMap[state.screen] || screenMap.start}
    <${NavBar} screen=${state.screen} dispatch=${dispatch} />
  `;
}

// ═══════════════════════════════════════════════════════════════
// SECTION 9: RENDER
// ═══════════════════════════════════════════════════════════════

render(html`<${App} />`, document.getElementById('app'));

  </script>
</body>
</html>
